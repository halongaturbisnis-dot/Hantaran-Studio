import React, { useState, useCallback, useMemo, useRef, useEffect } from 'react';
import {
  Menu, X, Sparkles, Wand2, Image as ImageIcon, Camera, Layout, Palette, Send, Box,
  Droplet, Layers, Zap, Upload, FileUp, CircleUser, Settings, ChevronRight,
  ClipboardList, Gem, Feather, Leaf, Gift, AlertTriangle, FileText, Plus, Trash2, Printer,
  Download, ZoomIn, ZoomOut, Maximize2, RotateCcw, FileImage, User, Hand,
  ScrollText, PanelRight, PanelLeft, ClipboardCheck, PenTool, CheckSquare,
  Calendar, StickyNote, Eraser, Flower, ChevronLeft, Coins, Sun, Clock
} from 'lucide-react';

// FIREBASE IMPORTS (MANDATORY for persistence)
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
// PERBAIKAN: Menambahkan doc, updateDoc, deleteDoc untuk fungsi CRUD
import { getFirestore, doc, addDoc, updateDoc, deleteDoc, onSnapshot, collection, query, orderBy, Timestamp } from 'firebase/firestore';

// --- CONFIGURASI & DATA KONSTAN ---

const colors = {
  bg: '#F9E6E6',
  primary: '#A8C3A0',
  secondary: '#D8A7A7', // Warna ini akan digunakan untuk tombol close merah
  supporting: '#B8A58C',
  text: '#3C3C3C',
  accent: '#D4AF37',
};

// PERUBAHAN 1 & 2: Urutan dan Ikon Modul
const MODULES = [
  { name: 'Magic Photo', icon: Wand2, id: 'magic', disabled: false }, // Urutan ke-1, Ikon Wand2
  { name: 'Inspiration', icon: Gift, id: 'arrangement' }, // Urutan ke-2, Ikon Gift
  { name: 'Mahar Design', icon: Layout, id: 'mahar' }, // Urutan ke-3, Ikon Layout
  { name: 'Flower Bouquet', icon: Flower, id: 'bouquet' }, 
  { name: 'Order Tracker', icon: Calendar, id: 'tracker' }, // NEW MODULE
  { name: 'Item Checker', icon: ClipboardCheck, id: 'checker' }, // Urutan ke-5
  { name: 'Invoice Maker', icon: ScrollText, id: 'invoice' }, // Urutan ke-6
];

const ORDER_STATUSES = ['Pending', 'Confirmed', 'Processing', 'Ready', 'Completed', 'Cancelled'];

const PRESET_OPTIONS = {
  decoration: {
    Theme: [
        "Royal Grandeur", "Rustic Vintage", "Modern Minimalist", "Shabby Chic / Romantic",
        "Bohemian Luxe", "Oriental Klasik", "English Garden", "Classic Timeless",
        "Art Deco Glamour", "Tropical Elegant", "Celestial Starlight",
        "Monochrome Sophistication", "Mediterranean Classic", "Fairy Tale Whimsical"
    ],
    Style: [
        "High-End Luxury", "Elegant Formal", "Refined Minimalist", "Romantic & Soft",
        "Artisanal Crafted", "Classic & Timeless", "Modern Contemporary",
        "Understated Elegance", "Sleek & Polished"
    ],
    ColorPalette: [
        "Pastel Dreams (Dusty Rose, Peach, Mint)", "Classic White & Gold",
        "Monochrome & Ivory (Putih, Krem, Beige)", "Earth Tones (Terracotta, Sage Green, Khaki)",
        "Jewel Tones (Emerald, Sapphire, Ruby, Gold)", "Bold Navy & Silver",
        "Burgundy & Copper (Maroon, Tembaga)", "Shades of Pink & Mauve (Merah Jambu, Ungu Pucat)",
        "Muted Tones (Abu-abu Muda, Biru Pudar, Lilac)", "Tropical Sunset (Orange, Kuning, Fusia)"
    ],
    Culture: [
        "Jawa Klasik (Yogyakarta/Surakarta)", "Jawa Modern (Umum Jawa)", "Jawa Timur (Malangan/Surabayan)",
        "Madura", "Sunda Priangan", "Minangkabau", "Batak", "Melayu", "Bugis-Makassar",
        "Bali", "Dayak (Kalimantan)", "Banjar (Kalimantan)", "Sasak (Lombok)",
        "NTT (Nusa Tenggara Timur)", "Maluku & Papua", "Indonesian Modern",
        "Chinese Traditional", "Indian", "Arabic", "International Western"
    ],
    PropDensity: [
        "Ultra Minimal (Hampir Tanpa Dekorasi Tambahan)", "Low Density (Hanya Sedikit Sentuhan Estetis)",
        "Medium Density (Seimbang, Ruang Kosong Masih Terlihat)", "High Density (Penuh Detail, Wadah Hampir Tertutup Dekorasi)",
        "Overflowing (Dekorasi Meluap Keluar Wadah/Penopang)"
    ],
    ItemArrangement: [
        "Single Layered (Diletakkan Datar di Satu Lapisan)", "Stacked Vertically (Ditumpuk Rapi ke Atas)",
        "Pyramid Shape (Barang Paling Besar di Bawah, Mengerucut ke Atas)", "Focal Point Display (Satu Item Utama Menonjol di Tengah)",
        "Grouped by Type (Barang Sejenis Dikelompokkan Bersama)", "Flowing Contour (Penataan Mengikuti Garis Melengkung/Lembut)",
        "Vertical Folding (Item Dilipat Berdiri Tegak)", "S-Curve Layout (Penataan Mengikuti Bentuk Kurva 'S')"
    ],
    Container: [
        "Kotak Akrilik Bening (Full Transparan)", "Kotak Kaca Berpenutup (Glass Dome)", "Kotak Kayu Ukir Klasik",
        "Nampan Beludru Mewah (Velvet Tray)", "Keranjang Rotan Anyaman (Rustic)", "Wadah Geometris Logam (Minimalis)",
        "Nampan Kayu Jati / Minimalis", "Bingkai Pigura Dekoratif (Frame Display)", "Piringan Keramik / Porcelain Hias",
        "Wadah Kuningan/Tembaga (Vintage Brass)", "Sangkar Burung (Bird Cage) Dekoratif", "Nampan Cermin (Mirror Tray)",
        "Wadah Bahan Kulit Sintetis (Leatherette Box)", "Display Box Tanpa Tutup (Open Box)"
    ],
    ContainerSize: ['Small (15cm)', 'Medium (25cm)', 'Large (35cm)'],
    DecorationElement: [
        "Fresh Flowers (Bunga Segar)", "Dried/Artificial Flowers (Bunga Kering/Artifisial)",
        "Foliage & Greenery (Daun-daunan)", "Silk Ribbon & Tulle (Pita Satin dan Kain Tulle)",
        "Lace & Brocade Fabric (Kain Renda dan Brokat)", "Beads & Pearls (Mutiara dan Manik-manik)",
        "Feathers & Pampas Grass (Bulu dan Rumput Pampas)", "Custom Name Tags & Calligraphy (Tag Nama dan Kaligrafi)",
        "LED Fairy Lights (Lampu Hias Kecil)", "Crystallized Embellishments (Hiasan Kristal)"
    ],
  },
  photoStyle: {
    BackgroundColor: [
        "Crisp White", "Soft Ivory (Off-White)", "Jet Black", "Muted Light Grey",
        "Dusty Pink", "Classic Navy Blue", "Deep Emerald Green", "Sage Green",
        "Warm Terracotta", "Metallic Gold", "Metallic Silver", "Velvet Burgundy",
        "Blush Peach", "Dove Blue"
    ],
  },
  bouquet: {
      Theme: [
          "Romantic Valentine", "Korean Style (Airy & Soft)", "Rustic Wildflower", 
          "Classic Elegant", "Modern Minimalist", "Bohemian Chic", "Luxury Glamour", 
          "Tropical Vibrant", "Graduation Celebration", "Bridal Hand Bouquet"
      ],
      Style: [
          "Round Shape (Bulat Padat)", "Hand-Tied (Ikat Alami)", "Cascade (Menjuntai ke Bawah)", 
          "Posy (Kecil & Simpel)", "Presentation / Pageant (Memanjang)", "Asymmetrical (Seni Bebas)",
          "Single Stem Statement", "Giant Bouquet (Ukuran Jumbo)"
      ],
      ColorPalette: [
          "Soft Pastels (Pink, Peach, White)", "Passionate Red & Maroon", 
          "Pure White & Greenery", "Sunny Yellow & Orange", "Moody Purple & Lilac",
          "Blue & White (Delft Blue)", "Autumn Tones (Terracotta, Brown)", "Rainbow / Colorful"
      ],
      FlowerCombination: [
          "Classic Roses Only", "Peonies & Ranunculus", "Tulips & Hyacinths",
          "Sunflowers & Chamomile", "Baby's Breath (Gypsophila) Only", 
          "Mixed Garden Flowers", "Lilies & Orchids", "Dried Flowers (Cotton, Wheat, Lavender)",
          "Hydrangea & Delphinium"
      ],
      Binding: [
          "Satin Ribbon Bow (Pita Satin)", "Raw Silk Ribbon (Pita Sutra Kasar)",
          "Jute Rope / Burlap (Tali Goni/Goni)", "Velvet Ribbon (Pita Beludru)",
          "Lace Wrapping (Renda)", "Hidden Binding (Tersembunbyi)"
      ],
      Wrapper: [
          "Korean Paper (Kertas Waterproof Warna-warni)", "Kraft Paper (Coklat Rustic)",
          "Cellophane (Plastik Bening/Kilap)", "Tissue Paper (Kertas Tisu)",
          "Fabric Wrap (Kain Tulle/Organza)", "Newsprint Style (Koran Vintage)",
          "No Wrapper (Naked Stems)"
      ]
  },
  mahar: {
      FrameShape: [
          "3D Shadow Box - Square (Kotak)", "3D Shadow Box - Hexagon (Segienam)",
          "3D Shadow Box - Arch (Lengkung)", "3D Shadow Box - Round (Bulat)",
          "Floating Frame (Kaca Ganda Transparan)", "Terrarium Geometric Glass",
          "Classic Carved Wood Frame (Ukiran)"
      ],
      ArrangementStyle: [
          "Rustic Dried Flowers (Bunga Kering)", "Modern Minimalist Acrylic",
          "Laser Cut Wood Art", "Paper Quilling Art", "Money Origami (Bentuk Uang)",
          "Preserved Moss & Greenery", "Elegant Floral Wreath"
      ],
      Culture: [
          "Javanese Gunungan (Wayang)", "Sunda Siger Detail", "Melayu Songket Pattern",
          "Aceh Pintu Aceh", "Padang Rumah Gadang", "Modern International (No specific culture)",
          "Islamic Calligraphy (Arabic)", "Chinese Double Happiness"
      ],
      DecorationItems: [
          "Uang Kertas Mainan & Koin", "Perhiasan Emas & Cincin Dummy",
          "Logam Mulia (Replika Emas Batangan)", "Seperangkat Alat Sholat",
          "Bunga Edelweiss & Gandum Kering", "Lampu LED Strip Warm White"
      ],
      BackgroundFabric: [
          "Soft Cream Velvet Drapery", "Elegant White Silk Drapery", "Moody Maroon Velvet Drapery",
          "Deep Navy Blue Satin Drapery", "Earthy Sage Green Linen Drapery", "Dusty Pink Chiffon Drapery",
          "Neutral Grey Cotton Drapery"
      ]
  },
  magic: {
    Environment: [
        "Studio Profesional", "Wedding Venue", "Indoor Cafe", "Outdoor Garden", 
        "Living Room (Homey)", "Luxury Hotel Lobby", "Minimalist Concrete Space"
    ],
    Backgrounds: {
        "Studio Profesional": ["Polos - Putih Bersih", "Polos - Hitam Elegan", "Abstrak - Tekstur Kanvas", "Gradasi - Warna Pastel"],
        "Wedding Venue": ["Pelaminan Bunga Mewah", "Meja Akad Dekorasi", "Lorong Gedung Mewah", "Lampu Gantung Kristal"],
        "Indoor Cafe": ["Meja Kayu & Jendela", "Sudut Sofa Estetik", "Latar Rak Buku", "Cahaya Lampu Hangat"],
        "Outdoor Garden": ["Rumput Hijau & Bunga", "Bawah Pohon Rindang", "Saat Golden Hour (Sore)", "Pagar Kayu Putih"],
        "Living Room (Homey)": ["Meja Tamu Marmer", "Sofa Beludru Empuk", "Dekat Jendela Berhorden", "Karpet Bulu Halus"],
        "Luxury Hotel Lobby": ["Lantai Marmer Mengkilap", "Dinding Panel Kayu", "Lampu Hias Besar", "Tangga Spiral Mewah"],
        "Minimalist Concrete Space": ["Dinding Semen Ekspos", "Lantai Beton Halus", "Cahaya Bayangan Tajam", "Podium Geometris"]
    },
    PosesHandCarry: [
        "Memegang lembut dari bawah (Underhand Grip)", "Satu tangan menopang, satu menyentuh detail",
        "Close-up jari memegang sisi wadah", "Dua tangan membawa di depan dada",
        "Sudut pandang POV (Point of View) memegang hantaran"
    ],
    PosesModel: [
        "Pengantin wanita memegang di depan pinggang (Formal)", "Pasangan saling memegang hantaran (Romantis)",
        "Model duduk memangku hantaran", "Candid shot sedang menata/melihat hantaran",
        "Walking shot (Berjalan membawa hantaran)", "Close up wajah model dengan hantaran di samping"
    ],
    ItemPosition: [
        "Berdiri Tegak (Standing Upright)", 
        "Disenderkan Miring (Leaning Back)", 
        "Direbahkan (Laying Flat / Flatlay)"
    ],
    Mood: [
        "Romantic & Dreamy", "Luxurious & Expensive", "Rustic & Warm",
        "Clean & Sterile (E-commerce style)", "Vintage & Nostalgic", "Joyful & Vibrant"
    ],
    LayoutImage: [
        "1:1 (Square)", "9:16 (Story)", "4:3 (Landscape)", "3:4 (Portrait)"
    ]
  }
};

const APP_LOGO_URL = "https://lh3.googleusercontent.com/d/1LNdn8mDbGAUzicCvbOwYPCyFjc4B6UhA";

// Firestore Helper (Must be outside component scope to avoid re-creation)
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const getCollectionPath = (userId) => {
    // Mandated private collection path
    return `artifacts/${appId}/users/${userId}/orders`;
};


// --- GLOBAL HELPER: UNIVERSAL DOWNLOAD/SHARE (IOS & MOBILE FRIENDLY) ---
// REVISI STRATEGI: Menggunakan pendekatan Hybrid (Web Share API > Blob URL > New Tab)

const safeDownload = async (dataUrl, filename) => {
    try {
        // 1. Konversi Data URL ke Blob & File Object (Penting agar data biner diakui browser)
        const arr = dataUrl.split(',');
        // Extract MIME type robustly
        const mimeMatch = arr[0].match(/:(.*?);/);
        const mime = mimeMatch && mimeMatch[1] ? mimeMatch[1] : 'image/png'; // Default ke PNG jika ekstrak gagal
        
        const bstr = atob(arr[1]);
        let n = bstr.length;
        const u8arr = new Uint8Array(n);
        while (n--) {
            u8arr[n] = bstr.charCodeAt(n);
        }
        const blob = new Blob([u8arr], { type: mime });
        const file = new File([blob], filename, { type: mime });

        // DETEKSI DEVICE: Pisahkan strategi Desktop vs Mobile
        // iOS/Safari tidak stabil dengan programmatic download biasa
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

        // 2. STRATEGI UTAMA (KHUSUS MOBILE/iOS): Web Share API
        // Jika browser mendukung sharing file (iOS 15+, Chrome Android), gunakan ini.
        if (isMobile && navigator.canShare && navigator.canShare({ files: [file] })) {
            try {
                await navigator.share({
                    files: [file],
                    title: filename,
                    text: 'Dibuat dengan Hantaran Studio App'
                });
                console.log("Berhasil dibagikan via Web Share API");
                return; // Sukses, keluar dari fungsi
            } catch (shareError) {
                // Abaikan jika user membatalkan share, tapi log error lain
                if (shareError.name !== 'AbortError') {
                    console.error("Web Share API gagal, mencoba metode fallback...", shareError);
                    // Lanjut ke strategi berikutnya (Blob Download)
                } else {
                    return; // User cancel, selesai.
                }
            }
        }

        // 3. STRATEGI DEFAULT (DESKTOP & FALLBACK MOBILE): Blob URL Download
        // Blob URL jauh lebih stabil daripada Data URI panjang untuk atribut 'download'
        const blobUrl = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = blobUrl;
        link.download = filename;
        link.style.display = 'none'; // Tambahkan style untuk menyembunyikan elemen
        document.body.appendChild(link);
        
        // Trigger download
        link.click();
        
        // PERBAIKAN AKHIR UNTUK DESKTOP/WINDOWS:
        // Bersihkan memori dan elemen DOM (1 detik delay untuk memastikan browser Desktop/Windows memicu dialog simpan)
        // Menunda penghapusan elemen <a> sangat penting untuk kompatibilitas Desktop.
        setTimeout(() => {
            document.body.removeChild(link); // Hapus elemen <a> setelah download dipicu
            URL.revokeObjectURL(blobUrl);     // Bersihkan memori Blob
        }, 1000); // 1 detik delay
        
        console.log("Berhasil didownload via Blob URL");

    } catch (error) {
        console.error("Semua metode download gagal:", error);
        
        // 4. STRATEGI TERAKHIR (EMERGENCY): Buka di Tab Baru
        // Ini adalah fallback terkuat untuk iOS/Safari yang memblokir programmatic download.
        const newTab = window.open();
        if (newTab) {
            // Menggunakan warna dari config untuk UI yang konsisten
            const primaryColor = colors.primary.replace('#', '');
            const secondaryColor = colors.secondary.replace('#', '');
            const textColor = colors.text.replace('#', '');

            newTab.document.write(`
                <div style="display:flex;flex-direction:column;justify-content:center;align-items:center;height:100vh;background:#f0f0f0;padding:20px;text-align:center;">
                    <h1 style="color:#${secondaryColor};">Gagal Download Otomatis!</h1>
                    <p style="color:#${textColor};margin-bottom:20px;font-size:16px;">
                        Pada perangkat iOS/Safari, silakan <strong>Tekan dan Tahan</strong> gambar di bawah (Long Press), lalu pilih <strong>'Save Image'</strong> atau <strong>'Simpan Gambar'</strong> dari menu yang muncul.
                    </p>
                    <img src="${dataUrl}" style="max-width:100%;max-height:70vh;box-shadow:0 8px 16px rgba(0,0,0,0.2);border-radius:12px;border: 4px solid #${primaryColor};"/>
                    <small style="margin-top:20px;color:#${textColor};">Tutup tab ini setelah berhasil menyimpan.</small>
                </div>
            `);
            newTab.document.title = "Tekan lama gambar untuk menyimpan";
        } else {
             console.error("Gagal membuka tab baru. Pastikan pop-up diizinkan.");
        }
    }
};

// Helper function for fetching with retry logic
const fetchWithRetry = async (url, options, maxRetries = 3) => {
    const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));
    for (let i = 0; i < maxRetries; i++) {
        try {
            const response = await fetch(url, options);
            if (response.ok) return response;
            if (response.status === 429 || response.status >= 500) {
                if (i === maxRetries - 1) throw new Error(`API call failed after ${maxRetries} retries: ${response.statusText}`);
                // Exponential backoff
                await delay(Math.pow(2, i) * 1000); continue;
            }
            throw new Error(`API error: ${response.statusText}`);
        } catch (error) {
            if (i === maxRetries - 1) throw error;
            // Exponential backoff for network errors
            await delay(Math.pow(2, i) * 1000);
        }
    }
};

// Helper to fetch data URL and convert it to base64 data string AND extract MIME type
// PERBAIKAN: Fungsi ini diubah untuk mengembalikan B64 dan MIME Type secara dinamis.
const parseDataURL = (dataUrl) => {
    if (!dataUrl || !dataUrl.startsWith('data:')) return { base64: null, mimeType: null };
    const parts = dataUrl.split(',');
    const metadata = parts[0].split(';');
    const mimeType = metadata[0].replace('data:', '');
    return { base64: parts[1], mimeType: mimeType || 'image/png' }; // Default ke PNG (karena output Gemini Image selalu PNG)
};

// --- KOMPONEN UI DASAR ---

const InputGroup = ({ label, children, isAuto, onToggleAuto, required, disabled = false }) => (
  <div className={`flex flex-col gap-2 p-4 rounded-xl shadow-inner bg-white/70 backdrop-blur-sm border border-gray-200 transition-all hover:shadow-md ${disabled ? 'opacity-50 pointer-events-none grayscale' : ''}`}>
    <div className="flex justify-between items-center text-sm font-semibold text-gray-700">
      <label className="flex items-center gap-1">
        {label} {required && <span className="text-red-500">*</span>}
      </label>
      {onToggleAuto && !disabled && (
        <label className="flex items-center cursor-pointer group">
          <span className={`mr-2 text-xs font-medium transition-colors ${isAuto ? 'text-[${colors.primary}]' : 'text-gray-400'}`}>Auto</span>
          <div className={`relative inline-block w-9 h-5 rounded-full transition duration-300 ease-in-out ${isAuto ? `bg-gradient-to-r from-[${colors.primary}] to-[${colors.supporting}]` : 'bg-gray-300'}`}>
            <input type="checkbox" checked={isAuto} onChange={onToggleAuto} className="sr-only" />
            <div className={`absolute left-1 top-1 w-3 h-3 bg-white rounded-full transition-transform duration-300 ease-in-out ${isAuto ? 'translate-x-4' : 'translate-x-0'}`} />
          </div>
        </label>
      )}
    </div>
    <div className={`transition-all duration-300 ${isAuto ? 'opacity-50 pointer-events-none grayscale' : 'opacity-100'}`}>
        {children}
    </div>
  </div>
);

const Dropdown = ({ value, onChange, options, disabled, placeholder = "Pilih salah satu..." }) => (
  <select
    value={value}
    onChange={onChange}
    disabled={disabled}
    className={`w-full p-2 border rounded-lg focus:ring-2 focus:ring-[${colors.primary}] outline-none text-sm transition ${disabled ? 'bg-gray-100 text-gray-400' : 'bg-white border-gray-300 text-gray-700'}`}
    style={{ color: disabled ? '#9CA3AF' : colors.text, borderColor: disabled ? '#E5E7EB' : '#D1D5DB' }}
  >
    <option value="" disabled>{placeholder}</option>
    {options.map(opt => (
      <option key={opt} value={opt}>{opt}</option>
    ))}
  </select>
);

const FileUpload = ({ label, onFilesChange, maxFiles, files, disabled }) => {
  const fileCount = files.length;
  const isMax = fileCount >= maxFiles;
  const handleChange = (e) => {
    const newFiles = Array.from(e.target.files).slice(0, maxFiles - fileCount);
    onFilesChange([...files, ...newFiles]);
    e.target.value = null;
  };
  const handleRemove = (index) => {
    onFilesChange(files.filter((_, i) => i !== index));
  };
  const getFilePreviewUrl = (file) => {
    if (file instanceof File) return URL.createObjectURL(file);
    return '';
  };
  return (
    <div className={`space-y-3 ${disabled ? 'opacity-60 grayscale' : ''}`}>
      <div className="text-xs text-gray-600">{label}<span className="ml-1 text-gray-500">(Max: {maxFiles} file)</span></div>
      <div className="flex flex-wrap gap-3">
        {files.map((file, index) => (
          <div key={index} className="relative w-24 h-24 rounded-xl shadow-md overflow-hidden group border-2 border-transparent hover:border-gray-300 transition duration-150">
            <img src={getFilePreviewUrl(file)} alt={`Preview ${file.name}`} className="w-full h-full object-cover" />
            {!disabled && (
              <button type="button" onClick={() => handleRemove(index)} className="absolute inset-0 flex items-center justify-center bg-black/40 opacity-0 group-hover:opacity-100 transition duration-300" title="Hapus Foto">
                <X className="w-5 h-5 text-white" />
              </button>
            )}
          </div>
        ))}
        {!isMax && !disabled && (
          <label className={`w-24 h-24 flex flex-col items-center justify-center border-2 border-dashed rounded-xl cursor-pointer transition hover:border-[${colors.primary}] hover:text-[${colors.primary}]`} style={{ borderColor: colors.supporting, color: colors.supporting }}>
            <Upload className="w-5 h-5" />
            <span className="text-xs mt-1 text-center">Tambah Foto ({fileCount}/{maxFiles})</span>
            <input type="file" multiple onChange={handleChange} className="hidden" accept="image/*" disabled={disabled} />
          </label>
        )}
      </div>
    </div>
  );
};

const OpenTextarea = ({ value, onChange, placeholder, disabled, required }) => (
  <textarea
    value={value}
    onChange={onChange}
    placeholder={placeholder}
    disabled={disabled}
    rows="3"
    className={`w-full p-3 border rounded-lg focus:ring-2 focus:ring-[${colors.supporting}] outline-none text-sm transition resize-none ${disabled ? 'bg-gray-100 text-gray-400' : 'bg-white border-gray-300 text-gray-700'}`}
    style={{ color: disabled ? '#9CA3AF' : colors.text, borderColor: disabled ? '#E5E7EB' : '#D1D5DB' }}
  />
);

const SkeletonLoading = ({ primaryColor, secondaryColor, bgColor }) => (
  <div className="animate-pulse flex flex-col gap-6 w-full h-full justify-center">
    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 w-full">
        <div className="col-span-1 p-2 rounded-xl" style={{ backgroundColor: bgColor }}>
             <div className="w-full aspect-square rounded-lg" style={{ backgroundColor: secondaryColor + '30' }} />
        </div>
        <div className="col-span-1 p-2 rounded-xl" style={{ backgroundColor: bgColor }}>
             <div className="w-full aspect-square rounded-lg" style={{ backgroundColor: secondaryColor + '30' }} />
        </div>
    </div>
  </div>
);

const SkeletonGrid = ({ primaryColor, secondaryColor }) => (
    <div className="grid grid-cols-2 gap-4">
        {[1, 2].map(i => (
             <div key={i} className="aspect-square rounded-xl animate-pulse" style={{ backgroundColor: secondaryColor + '20' }}>
                 <div className="w-full h-full flex items-center justify-center opacity-20">
                     {/* FIX: Error pada baris 356. Icon JSX harus ditutup dengan '/' */}
                     <ImageIcon className="w-8 h-8" style={{ color: primaryColor }} />
                 </div>
             </div>
        ))}
    </div>
);

const renderProTips = (text) => {
    if (!text) return null;
    let safeText = text.replace(/â€”|;|[*]/g, '');
    safeText = safeText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    return (
        <p className="font-normal leading-relaxed text-justify" dangerouslySetInnerHTML={{ __html: safeText }} />
    );
};

// --- KOMPONEN BARU: IMAGE BRUSH OVERLAY UNTUK EDIT LANJUTAN ---

// Utility to create a black/white mask image from a drawn canvas (used by the API)
const createApiMask = (drawingCanvas) => {
    if (!drawingCanvas) return null;
    
    const w = drawingCanvas.width;
    const h = drawingCanvas.height;
    
    // 1. Create a temporary canvas for the final API mask
    const maskCanvas = document.createElement('canvas');
    maskCanvas.width = w;
    maskCanvas.height = h;
    const ctx = maskCanvas.getContext('2d');
    
    // 2. Get pixel data from the user's drawing
    const drawingCtx = drawingCanvas.getContext('2d');
    const drawingData = drawingCtx.getImageData(0, 0, w, h);
    const apiMaskData = ctx.createImageData(w, h); // Start with a new, blank image data
    
    // Mask convention: Black (RGB 0,0,0) = Area to EDIT/CHANGE. White (RGB 255,255,255) = Area to KEEP.
    for (let i = 0; i < drawingData.data.length; i += 4) {
        // Check the alpha channel (drawingData.data[i + 3]) of the drawing canvas.
        // If the alpha is high (i.e., the user drew something), make the mask pixel black.
        if (drawingData.data[i + 3] > 0) {
            // Area drawn on -> set to BLACK (0, 0, 0)
            apiMaskData.data[i] = 0;       // R
            apiMaskData.data[i + 1] = 0;   // G
            apiMaskData.data[i + 2] = 0;   // B
            apiMaskData.data[i + 3] = 255; // A (Fully Opaque Black)
        } else {
            // Area not drawn on -> set to WHITE (255, 255, 255)
            apiMaskData.data[i] = 255;     // R
            apiMaskData.data[i + 1] = 255; // G
            apiMaskData.data[i + 2] = 255; // B
            apiMaskData.data[i + 3] = 255; // A (Fully Opaque White)
        }
    }
    
    ctx.putImageData(apiMaskData, 0, 0);
    
    // Return the Base64 representation of the mask image
    return maskCanvas.toDataURL('image/png');
};


const ImageBrushOverlay = ({ imageUrl, onMaskChange, colors, isProcessing }) => {
    const canvasRef = useRef(null);
    const imgRef = useRef(null);
    const [isDrawing, setIsDrawing] = useState(false);
    const [brushSize, setBrushSize] = useState(25);
    const [hasDrawn, setHasDrawn] = useState(false);
    const brushColor = colors.secondary; // Use secondary color (pink/red) for visibility

    // Initial setup and clear logic
    const setupCanvas = useCallback(() => {
        const canvas = canvasRef.current;
        const img = imgRef.current;
        if (!canvas || !img || img.naturalWidth === 0) return;

        // Set canvas size to match the displayed image size
        canvas.width = img.width;
        canvas.height = img.height;

        const ctx = canvas.getContext('2d');
        ctx.lineCap = 'round';
        ctx.strokeStyle = brushColor;
        
        // Clear the canvas and internal mask state
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        onMaskChange(null);
        setHasDrawn(false);
    }, [brushColor, onMaskChange]);

    useEffect(() => {
        setupCanvas();
        // Re-setup when image loads or dimensions change (simulated by dependency)
        const handler = setTimeout(setupCanvas, 100);
        return () => clearTimeout(handler);
    }, [imageUrl, setupCanvas]);

    // Function to calculate coordinates relative to the canvas
    const getPos = (e) => {
        const canvas = canvasRef.current;
        const rect = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return {
            x: clientX - rect.left,
            y: clientY - rect.top
        };
    };

    // Drawing handlers
    const startDrawing = (e) => {
        if (isProcessing) return;
        setIsDrawing(true);
        setHasDrawn(true);
        const pos = getPos(e);
        const ctx = canvasRef.current.getContext('2d');
        ctx.lineWidth = brushSize;
        ctx.beginPath();
        ctx.moveTo(pos.x, pos.y);
    };

    const draw = (e) => {
        if (!isDrawing || isProcessing) return;
        e.preventDefault(); // Prevent scrolling on touch
        const pos = getPos(e);
        const ctx = canvasRef.current.getContext('2d');
        ctx.lineTo(pos.x, pos.y);
        ctx.stroke();
    };

    const stopDrawing = () => {
        if (isDrawing) {
            setIsDrawing(false);
            // After drawing stops, generate the API mask and pass it up
            const maskDataUrl = createApiMask(canvasRef.current);
            onMaskChange(maskDataUrl);
        }
    };
    
    // Clear Handler
    const handleClear = (e) => {
        e.stopPropagation();
        setupCanvas(); // Clears the canvas and resets mask state
    };
    
    const BrushIcon = PenTool;

    return (
        <div className="relative w-full aspect-square">
            {/* 1. Original Image (Hidden, but used for ref measurement) */}
            <img 
                ref={imgRef} 
                src={imageUrl} 
                alt="Original" 
                className="w-full h-full object-contain rounded-lg border-4 shadow-inner" 
                style={{ borderColor: colors.supporting }} 
                onLoad={() => {
                     // Ensure canvas is setup after image loads and is measured
                     setupCanvas();
                     setHasDrawn(false); // Reset drawing state on new image load
                }}
                crossOrigin="anonymous" // Penting untuk mencegah error CORS saat canvas membaca data gambar
            />

            {/* 2. Drawing Canvas Overlay */}
            <canvas
                ref={canvasRef}
                className="absolute top-0 left-0 cursor-crosshair touch-none mix-blend-multiply opacity-80"
                style={{ 
                    border: `4px solid ${colors.supporting}`, 
                    borderRadius: '0.5rem', 
                    width: '100%', 
                    height: '100%', 
                    // Menggunakan warna sekunder sebagai warna brush
                    strokeStyle: brushColor,
                }}
                onMouseDown={startDrawing}
                onMouseMove={draw}
                onMouseUp={stopDrawing}
                onMouseLeave={stopDrawing}
                onTouchStart={startDrawing}
                onTouchMove={draw}
                onTouchEnd={stopDrawing}
            />
            
            {/* 3. Controls */}
            <div className="absolute top-2 right-2 flex flex-col items-end space-y-2">
                 {/* Brush Size Slider */}
                 <div className="flex items-center space-x-2 p-2 bg-black/40 backdrop-blur rounded-full shadow-lg">
                    <BrushIcon className="w-4 h-4 text-white" />
                    <input 
                        type="range" 
                        min="5" 
                        max="80" 
                        value={brushSize} 
                        onChange={(e) => setBrushSize(parseInt(e.target.value))} 
                        className="w-20 h-1 bg-gray-300 rounded-full cursor-pointer appearance-none [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:h-3 [&::-webkit-slider-thumb]:w-3 [&::-webkit-slider-thumb]:rounded-full"
                        style={{'--tw-ring-color': brushColor, backgroundColor: colors.supporting, '--tw-ring-offset-width': '1px', WebkitAppearance: 'none', MozAppearance: 'none'}}
                    />
                </div>
                
                {/* Clear Button */}
                {hasDrawn && (
                    <button 
                        onClick={handleClear} 
                        className="p-2 bg-red-500/80 text-white rounded-full shadow-lg hover:bg-red-600 transition flex items-center gap-1 text-xs font-semibold"
                        title="Hapus Masking"
                    >
                         <Eraser className="w-4 h-4" /> Clear
                    </button>
                )}
            </div>
            
            {/* 4. Help Text */}
            <div className="absolute bottom-2 left-2 text-[10px] text-white/80 p-1 bg-black/40 backdrop-blur rounded-lg">
                Gunakan kursor/jari untuk menandai area yang ingin diubah.
            </div>
        </div>
    );
};

// --- KOMPONEN RE-EDIT MODAL (Dengan Brush) ---

const ReEditModal = ({ isOpen, onClose, originalItem, onUpdateImage, colors }) => {
    // originalItem structure: { image: dataURL, index: number, layout: string (optional) }
    const [newPrompt, setNewPrompt] = useState('');
    const [isProcessing, setIsProcessing] = useState(false);
    const [maskDataURL, setMaskDataURL] = useState(null); // NEW: State for the mask

    if (!isOpen || !originalItem) return null;

    const handleRegenerate = async () => {
        if (!newPrompt.trim() || isProcessing) return;

        setIsProcessing(true);

        try {
            // PERBAIKAN: Menggunakan parseDataURL untuk mendapatkan B64 dan MIME Type
            const { base64: imageB64, mimeType: inputMimeType } = parseDataURL(originalItem.image);
            
            if (!imageB64) throw new Error("Gagal memproses gambar asli.");

            // --- STRUKTUR PROMPT DENGAN PENAMBAHAN MASKING INFO ---
            const editPrompt = `
                **SYSTEM INSTRUCTION: ROBUST IMAGE RE-EDIT & CHAIN OF THOUGHT (CoT)**
                Anda adalah CGI Artist dan Photo Retoucher level elite. Tugas Anda adalah melakukan re-edit pada gambar yang dilampirkan. 
                ${maskDataURL ? 
                    "JIKA MASKING ADA: Fokuskan perubahan Anda HANYA pada area hitam yang ditunjukkan oleh gambar mask. Area putih harus dipertahankan 100%." : 
                    "JIKA TIDAK ADA MASKING: Lakukan edit pada seluruh gambar sesuai instruksi pengguna, dengan memprioritaskan konsistensi objek utama."
                }

                **KRITERIA KEBERHASILAN (NON-NEGOTIABLE):**
                1.  **Stabilitas Identitas:** Jaga identitas objek utama (Hantaran/Mahar/Buket) agar 100% konsisten. JANGAN mengubah bentuk, logo, atau tekstur, kecuali diminta secara eksplisit.
                2.  **Presisi Edit:** HANYA ubah elemen yang diminta dalam instruksi pengguna. JANGAN sentuh bagian lain (misalnya, jika diminta mengganti bunga, jangan ubah latar belakang atau pencahayaan, kecuali instruksi pengguna memintanya).
                3.  **Kualitas:** Output harus 8k, photorealistic, dengan pencahayaan studio profesional.

                **CHAIN OF THOUGHT (CoT) - ANALISIS & RENCANA EKSEKUSI:**
                
                **1. Analisis Gambar Asli:**
                - Objek Utama: Identifikasi subjek (misalnya, Kotak Akrilik, Buket Mawar Merah).
                - Latar Belakang & Komposisi: Deskripsikan latar belakang dan rasio aspek gambar.
                
                **2. Analisis Instruksi Pengguna:**
                - Instruksi: "${newPrompt.trim()}"
                - Target Perubahan: Identifikasi secara spesifik elemen yang akan diubah (misalnya, Bunga diganti, Warna latar belakang diubah).
                
                **3. Rencana Komposisi & Rendering:**
                - Aksi Utama: Tentukan langkah teknis yang diperlukan (misalnya, Inpainting pada area mask untuk mengganti bunga).
                - Validasi Kriteria: Pastikan rencana ini memenuhi semua KRITERIA KEBERHASILAN.

                **INSTRUKSI GENERASI AKHIR (Final Output Instruction):**
                Berdasarkan analisis CoT di atas, hasilkan satu gambar baru yang **SECARA AKURAT** menggabungkan gambar asli dengan perubahan spesifik dari instruksi pengguna.
            `;
            // --- END PROMPT ---

            // --- PEMBANGUNAN PAYLOAD API (TIGA PART) ---
            const contents = [{
                role: "user",
                parts: [
                    { text: editPrompt },
                    // Part 1: Original Image
                    { inlineData: { mimeType: inputMimeType || "image/png", data: imageB64 } }
                ]
            }];

            // Part 3: Mask Image (Jika ada goresan)
            if (maskDataURL) {
                const parsedMask = parseDataURL(maskDataURL);
                const maskBase64 = parsedMask.base64;
                if (maskBase64) {
                    contents[0].parts.push({
                        // Mime type for mask image is always png
                        inlineData: { mimeType: 'image/png', data: maskBase64 } 
                    });
                }
            }

            const apiKey = "";
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`;

            const response = await fetchWithRetry(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: contents, // Gunakan contents yang sudah dimodifikasi
                    generationConfig: { responseModalities: ['IMAGE'] }
                })
            });

            if (!response.ok) throw new Error("API call failed.");

            const result = await response.json();
            const candidate = result?.candidates?.[0];

            if (!candidate) {
                console.error("API Response Result:", result);
                throw new Error("API tidak mengembalikan kandidat gambar.");
            }

            const finishReason = candidate.finishReason;

            if (finishReason === 'SAFETY') {
                throw new Error("Generasi diblokir karena kebijakan keamanan. Coba ubah prompt.");
            }
            if (finishReason === 'RECITATION') {
                throw new Error("Generasi diblokir karena potensi duplikasi konten. Coba prompt yang berbeda.");
            }
             // Check for general failure reasons other than STOP (successful) or MAX_TOKENS (can happen, but often means the image part is missing)
            if (finishReason !== 'STOP' && finishReason !== 'MAX_TOKENS') { 
                throw new Error(`Generasi gagal dengan alasan: ${finishReason}`);
            }

            const newBase64 = candidate?.content?.parts?.[0]?.inlineData?.data;

            if (!newBase64) {
                 throw new Error("Gambar baru tidak ditemukan. Coba lagi dengan prompt yang lebih sederhana atau ganti gambar sumber.");
            }

            const newImageUrl = `data:image/png;base64,${newBase64}`;
            
            // Call the callback to update the parent state
            onUpdateImage(originalItem.index, newImageUrl, originalItem.layout);
            
            setNewPrompt('');
            setMaskDataURL(null); // Clear mask state on success
            onClose(); // Close on success

        } catch (error) {
            console.error("Regenerate failed:", error);
            // alert(`Gagal meregenerasi gambar: ${error.message}.`); // Menghapus alert()
        } finally {
            setIsProcessing(false);
        }
    };

    return (
        // PERBAIKAN 1: Padding luar lebih kecil di mobile (p-4 -> p-2)
        <div className="fixed inset-0 z-[70] bg-black/80 flex items-center justify-center p-2 backdrop-blur-sm" onClick={isProcessing ? undefined : onClose}>
            {/* PERBAIKAN 2: Batas max-width dan max-height, serta overflow-y-auto agar bisa digulir */}
            <div 
                className="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[95vh] overflow-y-auto p-4 md:p-6" 
                onClick={(e) => e.stopPropagation()}
            >
                <div className="flex justify-between items-center border-b pb-3 mb-4">
                    <h3 className="text-xl font-bold flex items-center gap-2" style={{ color: colors.text }}>
                        <Wand2 className="w-5 h-5" style={{ color: colors.accent }} /> Edit Gambar Lanjutan
                    </h3>
                    {!isProcessing && <button onClick={onClose} className="text-gray-500 hover:text-gray-700 p-1"><X className="w-6 h-6" /></button>}
                </div>

                <div className="flex flex-col md:flex-row gap-6">
                    {/* Kolom Kiri: Image Brush Overlay */}
                    <div className="w-full md:w-1/2 flex flex-col items-center">
                        <p className="text-sm font-semibold mb-2 flex items-center gap-1 text-center">
                            <PenTool className="w-4 h-4 text-gray-500"/> Gambar Asli ({originalItem.index + 1}) - Tandai area yang ingin diedit
                        </p>
                        {/* PERBAIKAN 3: Wrapper dengan max-height di mobile agar tidak memotong */}
                        <div className="w-full max-h-[60vh] md:max-h-[unset] flex items-center justify-center"> 
                            <ImageBrushOverlay
                                imageUrl={originalItem.image}
                                onMaskChange={setMaskDataURL}
                                colors={colors}
                                isProcessing={isProcessing}
                            />
                        </div>
                         {maskDataURL && (
                            <div className="mt-2 text-xs text-green-600 flex items-center gap-1">
                                <CheckSquare className="w-3 h-3"/> Masking aktif. AI akan fokus pada area yang ditandai.
                            </div>
                         )}
                    </div>
                    
                    {/* Kolom Kanan: Prompt Input */}
                    <div className="w-full md:w-1/2 space-y-4">
                        <OpenTextarea 
                            value={newPrompt} 
                            onChange={(e) => setNewPrompt(e.target.value)} 
                            placeholder={`Masukkan instruksi edit lanjutan di sini. 
Contoh: 'Ganti bunga menjadi mawar ungu tua' atau 'Tambahkan cahaya hangat dari samping.' 
(Jika Anda menandai area dengan kuas, AI akan memprioritaskan perubahan di area tersebut)`}
                            disabled={isProcessing}
                        />

                        {isProcessing ? (
                            <div className="flex items-center justify-center py-3 px-6 rounded-full text-white font-bold transition-all duration-300 shadow-lg" style={{ background: `linear-gradient(90deg, ${colors.primary} 0%, ${colors.supporting} 100%)` }}>
                                <svg className="animate-spin h-5 w-5 mr-3" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" fill="none" className="text-white opacity-25" /><path d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" fill="currentColor" /></svg>
                                Sedang Meregenerasi...
                            </div>
                        ) : (
                            <button 
                                onClick={handleRegenerate}
                                disabled={!newPrompt.trim()}
                                className={`w-full py-3 px-6 rounded-full text-white font-bold transition-all duration-300 shadow-lg flex items-center justify-center gap-2 ${!newPrompt.trim() ? 'opacity-60 cursor-not-allowed' : 'hover:scale-[1.02] hover:shadow-xl'}`} 
                                style={{ background: `linear-gradient(90deg, ${colors.secondary} 0%, ${colors.primary} 100%)` }}
                            >
                                <Wand2 className="w-5 h-5" /> Regenerate Gambar Ini
                            </button>
                        )}
                    </div>
                </div>
            </div>
        </div>
    );
};

// --- KOMPONEN TANDA TANGAN ---

// NEW: Pure Canvas Drawing Element (The actual drawing logic, lines 538-608 logic split out)
const SignatureDrawingElement = React.forwardRef(({ signatureData, onDrawEnd, colors, width = 300, height = 128 }, ref) => {
    const [isDrawing, setIsDrawing] = useState(false);

    useEffect(() => {
        const canvas = ref.current;
        if (!canvas) return;
        
        // Ensure canvas dimensions are set for pixel density
        canvas.width = width;
        canvas.height = height;

        const ctx = canvas.getContext('2d');
        ctx.lineWidth = 3; // Slightly thicker brush
        ctx.lineCap = 'round';
        ctx.strokeStyle = '#000000';
        
        ctx.clearRect(0, 0, width, height);

        if (signatureData) {
            const img = new Image();
            img.onload = () => {
                // Draw to fit (contain) the canvas area
                const ratio = Math.min(width / img.width, height / img.height);
                const newWidth = img.width * ratio;
                const newHeight = img.height * ratio;
                const x = (width - newWidth) / 2;
                const y = (height - newHeight) / 2;
                ctx.drawImage(img, x, y, newWidth, newHeight);
            };
            img.src = signatureData;
        }
    }, [signatureData, ref, width, height]);

    const getPos = (e) => {
        const canvas = ref.current;
        const rect = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return { x: clientX - rect.left, y: clientY - rect.top };
    };

    const startDrawing = (e) => {
        setIsDrawing(true);
        const pos = getPos(e);
        const ctx = ref.current.getContext('2d');
        ctx.beginPath();
        ctx.moveTo(pos.x, pos.y);
    };

    const draw = (e) => {
        if (!isDrawing) return;
        e.preventDefault(); // Prevent scrolling on touch
        const pos = getPos(e);
        const ctx = ref.current.getContext('2d');
        ctx.lineTo(pos.x, pos.y);
        ctx.stroke();
    };

    const stopDrawing = () => {
        if (isDrawing) {
            setIsDrawing(false);
            onDrawEnd(ref.current.toDataURL('image/png'));
        }
    };
    
    return (
        <canvas
            ref={ref}
            className="w-full h-full cursor-crosshair touch-none"
            onMouseDown={startDrawing}
            onMouseMove={draw}
            onMouseUp={stopDrawing}
            onMouseLeave={stopDrawing}
            onTouchStart={startDrawing}
            onTouchMove={draw}
            onTouchEnd={stopDrawing}
        />
    );
});


// NEW: Responsive Signature Pad Wrapper (Updated to remove modal and increase mobile height)
const SignaturePad = ({ label, onSave, onClear, signatureData, colors }) => {
    
    // Determine canvas height for drawing consistency (300x160 for mobile/default, 300x128 for large screen)
    const canvasHeight = 160; 

    return (
        <div className="flex flex-col gap-2">
            <label className="text-sm font-semibold text-gray-700">{label}</label>
            
            {/* Unified responsive drawing area: h-40 on mobile, h-32 on desktop */}
            <div className={`relative border-2 border-dashed rounded-xl bg-white overflow-hidden h-40 lg:h-32`} style={{ borderColor: colors.supporting }}>
                 {/* Preview or Drawing Area */}
                 {signatureData ? (
                     <div className="relative w-full h-full bg-white flex items-center justify-center">
                         {/* max-h-full agar gambar tidak terpotong */}
                         <img src={signatureData} className="max-h-full object-contain" alt="Sig" />
                         {/* Tombol Reset/Clear */}
                         <button onClick={onClear} className="absolute top-2 right-2 p-1 bg-gray-200 rounded hover:bg-red-100 text-red-500" title="Reset Tanda Tangan">
                             <Eraser className="w-4 h-4" />
                         </button>
                     </div>
                 ) : (
                    // Drawing view - set to full height of container
                    <SignatureDrawingElement 
                        signatureData={signatureData}
                        onDrawEnd={onSave}
                        colors={colors}
                        width={300} // Drawing width for pixel ratio
                        height={canvasHeight} // Drawing height for pixel ratio
                        ref={useRef(null)} 
                    />
                 )}
                 <div className="absolute top-2 right-2 text-xs text-gray-400 pointer-events-none">Area Tanda Tangan</div>
                 <div className="absolute bottom-2 left-2 text-[10px] text-gray-400 pointer-events-none">Tanda tangan disini</div>
            </div>
            
            {signatureData && <div className="text-xs text-green-600 flex items-center gap-1"><CheckSquare className="w-3 h-3"/> Tanda tangan tersimpan</div>}
        </div>
    );
};

// FIX: Helper untuk memformat Date object ke format lokal YYYY-MM-DDTHH:MM
// yang dibutuhkan oleh input[type="datetime-local"] tanpa pergeseran timezone.
const formatDateForInput = (dateObj) => {
    if (!dateObj || isNaN(dateObj.getTime())) return '';
    const year = dateObj.getFullYear();
    const month = String(dateObj.getMonth() + 1).padStart(2, '0');
    const day = String(dateObj.getDate()).padStart(2, '0');
    // Menggunakan waktu lokal (getHours/getMinutes)
    const hour = String(dateObj.getHours()).padStart(2, '0');
    const minute = String(dateObj.getMinutes()).padStart(2, '0');
    return `${year}-${month}-${day}T${hour}:${minute}`;
};


// --- MODULE: ORDER TRACKER (NEW MODULE) ---

const OrderTracker = ({ colors, db, userId, isAuthReady }) => {
    const [orders, setOrders] = useState([]);
    const [currentDate, setCurrentDate] = useState(new Date());
    const [selectedDay, setSelectedDay] = useState(null);
    const [isAddModalOpen, setIsAddModalOpen] = useState(false);
    // PERBAIKAN 4: Tambah field phone ke state
    const [newOrder, setNewOrder] = useState({ client: '', phone: '', service: '', date: '', status: ORDER_STATUSES[0] });
    // NEW: State untuk order yang sedang diedit
    const [editingOrder, setEditingOrder] = useState(null); 
    // PERBAIKAN 2: State untuk konfirmasi hapus
    const [confirmDelete, setConfirmDelete] = useState(null);

    // --- FIREBASE REAL-TIME LISTENER ---
    useEffect(() => {
        if (!isAuthReady || !db || !userId) return;

        const ordersColRef = collection(db, getCollectionPath(userId));
        // Menggunakan query untuk mengambil semua data (akan disaring di frontend)
        const q = query(ordersColRef, orderBy('date', 'desc'));
        
        const unsubscribe = onSnapshot(q, (snapshot) => {
            const fetchedOrders = [];
            snapshot.forEach(doc => {
                const data = doc.data();
                // Konversi Firestore Timestamp ke Date object jika ada
                const date = data.date instanceof Timestamp ? data.date.toDate() : new Date(data.date);
                fetchedOrders.push({
                    id: doc.id,
                    ...data,
                    date: date,
                });
            });
            setOrders(fetchedOrders);
        }, (error) => {
            console.error("Error listening to orders:", error);
        });

        return () => unsubscribe();
    }, [isAuthReady, db, userId]);

    // --- CALENDAR LOGIC ---

    const startOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
    const endOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
    const numDays = endOfMonth.getDate();
    const startDayOfWeek = startOfMonth.getDay(); // 0 for Sunday, 1 for Monday

    const days = [];
    // Isi hari-hari kosong di awal bulan
    for (let i = 0; i < startDayOfWeek; i++) {
        days.push(null);
    }
    // Isi hari-hari di bulan ini
    for (let i = 1; i <= numDays; i++) {
        const dayDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), i);
        days.push(dayDate);
    }

    const nextMonth = () => setCurrentDate(prev => new Date(prev.getFullYear(), prev.getMonth() + 1, 1));
    const prevMonth = () => setCurrentDate(prev => new Date(prev.getFullYear(), prev.getMonth() - 1, 1));

    const today = new Date();
    const isSameDay = (date1, date2) => date1 && date2 && date1.getDate() === date2.getDate() && date1.getMonth() === date2.getMonth() && date1.getFullYear() === date2.getFullYear();
    const isToday = (date) => isSameDay(date, today);

    // Filter orders for the selected day
    const ordersForSelectedDay = useMemo(() => {
        if (!selectedDay) return [];
        return orders.filter(order => isSameDay(order.date, selectedDay)).sort((a, b) => a.date - b.date);
    }, [orders, selectedDay]);

    // Group orders by day in the current month for badge count
    const ordersInCurrentMonth = useMemo(() => {
        const counts = {};
        orders.forEach(order => {
            if (order.date.getMonth() === currentDate.getMonth() && order.date.getFullYear() === currentDate.getFullYear()) {
                const day = order.date.getDate();
                counts[day] = (counts[day] || 0) + 1;
            }
        });
        return counts;
    }, [orders, currentDate]);

    // --- CRUD HANDLERS ---
    
    const handleCloseModal = () => {
        setIsAddModalOpen(false);
        setEditingOrder(null);
        setConfirmDelete(null); // Tutup konfirmasi hapus
        // PERBAIKAN 4: Reset state dengan field phone
        setNewOrder({ client: '', phone: '', service: '', date: '', status: ORDER_STATUSES[0] }); 
    }

    // Fungsi universal untuk membuka modal (Tambah atau Edit)
    const handleOpenAddModal = (orderToEdit = null, date = null) => {
        if (orderToEdit) {
            // EDIT MODE
            setEditingOrder(orderToEdit);
            setNewOrder({
                client: orderToEdit.client,
                phone: orderToEdit.phone || '', // PERBAIKAN 4: Ambil data phone
                service: orderToEdit.service,
                // FIX BUG TANGGAL: Menggunakan format lokal untuk menghindari pergeseran hari
                date: formatDateForInput(orderToEdit.date), 
                status: orderToEdit.status,
            });
        } else {
            // ADD MODE
            // PERBAIKAN 3: Gunakan selectedDay jika ada, jika tidak, gunakan hari ini
            let initialDate = date || today; 
            
            // FIX BUG TANGGAL: Jika tanggal datang dari kalender (date is not null), 
            // kita harus clone objeknya karena setHours akan memutasi objek aslinya.
            if (date) {
                initialDate = new Date(date.getTime()); // Clone date
                initialDate.setHours(9, 0, 0, 0); // Set default time to 09:00 AM local time
            }

            setEditingOrder(null);
            setNewOrder({ 
                client: '', 
                phone: '', // PERBAIKAN 4: Tambahkan field phone
                service: '', 
                // FIX BUG TANGGAL: Menggunakan format lokal untuk menghindari pergeseran hari
                date: formatDateForInput(initialDate), 
                status: ORDER_STATUSES[0] 
            });
        }
        setIsAddModalOpen(true);
    };

    // Fungsi universal untuk menambah atau mengedit order
    const handleAddOrUpdateOrder = async (e) => {
        e.preventDefault();
        if (!newOrder.client || !newOrder.date) return;

        try {
            const orderPayload = {
                client: newOrder.client,
                phone: newOrder.phone, // PERBAIKAN 4: Tambahkan phone ke payload
                service: newOrder.service,
                status: newOrder.status,
                // Simpan tanggal sebagai Firestore Timestamp
                date: Timestamp.fromDate(new Date(newOrder.date)), 
            };

            if (editingOrder) {
                // LOGIKA UPDATE (Ubah Order)
                const orderDocRef = doc(db, getCollectionPath(userId), editingOrder.id);
                await updateDoc(orderDocRef, orderPayload);
            } else {
                // LOGIKA TAMBAH (Order Baru)
                orderPayload.createdAt = Timestamp.now(); 
                await addDoc(collection(db, getCollectionPath(userId)), orderPayload);
            }

            handleCloseModal();
            // Tetapkan hari yang dipilih ke tanggal order baru/yang diubah untuk refresh list
            setSelectedDay(new Date(newOrder.date));

        } catch (error) {
            console.error(`Gagal ${editingOrder ? 'mengubah' : 'menambah'} order:`, error);
            // Tampilkan pesan error custom di sini (bukan alert)
        }
    };
    
    // PERBAIKAN 2: Fungsi Delete Order (dipicu oleh konfirmasi)
    const handleDeleteOrder = async (orderId) => {
        if (!orderId) return;
        
        try {
            await deleteDoc(doc(db, getCollectionPath(userId), orderId));
            console.log("Order deleted successfully:", orderId);
            setConfirmDelete(null); // Tutup konfirmasi setelah sukses
        } catch (error) {
            console.error("Gagal menghapus order:", error);
        }
    };
    
    // Fungsi untuk menampilkan konfirmasi (dipicu oleh tombol Trash2)
    const handleConfirmDeleteClick = (orderId, clientName) => {
        setConfirmDelete({ id: orderId, name: clientName });
    };

    // Helper untuk styling status
    const getStatusStyle = (status) => {
        switch (status) {
            case 'Confirmed': return 'bg-blue-100 text-blue-800 border-blue-300';
            case 'Processing': return 'bg-yellow-100 text-yellow-800 border-yellow-300';
            case 'Ready': return 'bg-purple-100 text-purple-800 border-purple-300';
            case 'Completed': return 'bg-green-100 text-green-800 border-green-300';
            case 'Cancelled': return 'bg-red-100 text-red-800 border-red-300';
            default: return 'bg-gray-100 text-gray-800 border-gray-300';
        }
    };
    
    // --- UI ELEMENTS ---
    
    if (!isAuthReady) {
        return <div className="p-8 text-center text-lg text-gray-500">Memuat data pengguna...</div>;
    }
    
    if (!db) {
         return <div className="p-8 text-center text-lg text-red-500">Koneksi Database Gagal. Harap refresh halaman.</div>;
    }

    return (
        <div className="p-4 md:p-6 flex flex-col gap-6">
            <h2 className="text-3xl font-bold flex items-center gap-2" style={{ color: colors.text }}>
                <Calendar className="w-6 h-6" style={{ color: colors.primary }} /> Order Tracker
            </h2>

            {/* Kontrol dan Kalender */}
            <div className="bg-white p-6 rounded-xl shadow-md border border-gray-200 grid grid-cols-1 lg:grid-cols-2 gap-6">
                
                {/* Kolom Kiri: Kalender */}
                <div className="flex flex-col">
                    <div className="flex justify-between items-center mb-4">
                        <button onClick={prevMonth} className="p-2 rounded-full hover:bg-gray-100 text-gray-600"><ChevronLeft className="w-5 h-5" /></button>
                        <h3 className="text-xl font-bold" style={{ color: colors.text }}>
                            {currentDate.toLocaleDateString('id-ID', { month: 'long', year: 'numeric' })}
                        </h3>
                        <button onClick={nextMonth} className="p-2 rounded-full hover:bg-gray-100 text-gray-600"><ChevronRight className="w-5 h-5" /></button>
                    </div>

                    <div className="grid grid-cols-7 text-center text-sm font-semibold text-gray-500 border-b pb-2 mb-2">
                        {['Min', 'Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab'].map(day => (
                            <span key={day}>{day}</span>
                        ))}
                    </div>

                    <div className="grid grid-cols-7 gap-1">
                        {days.map((day, index) => {
                            if (!day) return <div key={index} className="aspect-square"></div>;
                            
                            const dayNum = day.getDate();
                            const orderCount = ordersInCurrentMonth[dayNum] || 0;
                            const isCurrent = isSameDay(day, currentDate);
                            const isSelected = isSameDay(day, selectedDay);
                            const isTodayMarker = isToday(day);

                            return (
                                <div
                                    key={day.toISOString()}
                                    className={`relative aspect-square flex flex-col items-center justify-center p-1 rounded-lg cursor-pointer transition 
                                        ${isSelected ? 'ring-2 ring-offset-2 scale-105' : 'hover:bg-gray-100'}
                                    `}
                                    style={{ 
                                        // PERBAIKAN BACKGROUND: Mengganti background merah hari ini dengan warna primary yang lebih soft
                                        border: isTodayMarker ? `2px solid ${colors.secondary}` : 'none', 
                                        backgroundColor: isTodayMarker ? colors.primary + '15' : undefined, // Light primary color for today (15% opacity)
                                        ringColor: colors.primary 
                                    }}
                                    onClick={() => setSelectedDay(day)}
                                >
                                    {/* FIX: Set warna teks merah kuat untuk hari ini */}
                                    <span className={`text-sm font-medium ${isTodayMarker ? 'text-red-600 font-bold' : (isCurrent ? 'text-gray-800' : 'text-gray-400')}`}>{dayNum}</span>
                                    {orderCount > 0 && (
                                        <span className="absolute bottom-1 right-1 w-4 h-4 text-[10px] bg-red-500 text-white rounded-full flex items-center justify-center font-bold">{orderCount}</span>
                                    )}
                                </div>
                            );
                        })}
                    </div>
                    
                    <button 
                        // PERBAIKAN 3: Menggunakan selectedDay (jika ada) untuk mengisi tanggal di modal
                        onClick={() => handleOpenAddModal(null, selectedDay || today)} 
                        className="mt-6 py-2 rounded-full text-white font-bold transition flex items-center justify-center gap-2 hover:opacity-90"
                        style={{ backgroundColor: colors.primary }}
                    >
                        <Plus className="w-4 h-4" /> Tambah Order
                    </button>
                </div>

                {/* Kolom Kanan: Detail Order Hari Ini */}
                <div className="p-4 rounded-xl border border-dashed" style={{ borderColor: colors.supporting }}>
                    <div className="flex justify-between items-center mb-4 border-b pb-2">
                        <h3 className="text-xl font-bold flex items-center gap-2">
                            <ClipboardList className="w-5 h-5" /> Detail Orders
                        </h3>
                         <span className="text-sm font-semibold text-gray-500">
                             {selectedDay ? selectedDay.toLocaleDateString('id-ID', { day: 'numeric', month: 'short' }) : 'Pilih tanggal'}
                         </span>
                    </div>

                    {selectedDay && ordersForSelectedDay.length > 0 ? (
                        <div className="space-y-3 max-h-96 overflow-y-auto pr-2">
                            {ordersForSelectedDay.map(order => (
                                <div key={order.id} className="p-3 border rounded-lg bg-gray-50 shadow-sm flex flex-col gap-1">
                                    <div className="flex justify-between items-center">
                                        <p className="font-bold text-base">{order.client}</p>
                                        {/* Tombol Edit dan Delete */}
                                        <div className="flex items-center gap-1">
                                            <button 
                                                onClick={() => handleOpenAddModal(order)} 
                                                className="p-1 rounded-full text-blue-500 hover:bg-blue-100 transition" 
                                                title="Edit Order"
                                            >
                                                {/* PERBAIKAN 1: Menggunakan PenTool (Sudah Terpasang) */}
                                                <PenTool className="w-4 h-4" /> 
                                            </button>
                                            <button 
                                                // PERBAIKAN 2: Panggil fungsi konfirmasi custom
                                                onClick={() => handleConfirmDeleteClick(order.id, order.client)} 
                                                className="p-1 rounded-full text-red-500 hover:bg-red-100 transition" 
                                                title="Hapus Order"
                                            >
                                                <Trash2 className="w-4 h-4" />
                                            </button>
                                        </div>
                                    </div>
                                    <div className="flex justify-between items-center text-sm">
                                        <p className="text-gray-700">{order.service}</p>
                                        <span className={`text-xs px-2 py-0.5 rounded-full border font-semibold ${getStatusStyle(order.status)}`}>
                                            {order.status}
                                        </span>
                                    </div>
                                    <p className="text-xs text-gray-500 flex items-center gap-1">
                                        {order.phone && <span className="mr-2">HP: {order.phone}</span>}
                                        <Clock className="w-3 h-3"/> {order.date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })}
                                    </p>
                                </div>
                            ))}
                        </div>
                    ) : (
                         <div className="text-center py-10 text-gray-500 italic">
                             {selectedDay ? `Tidak ada order pada ${selectedDay.toLocaleDateString('id-ID')}` : 'Pilih tanggal pada kalender untuk melihat detail.'}
                         </div>
                    )}
                     <div className="mt-4 text-xs text-gray-400">
                        UserID: {userId || 'Loading...'} 
                    </div>
                </div>

            </div>

            {/* Modal Tambah/Edit Order */}
            {isAddModalOpen && (
                <div className="fixed inset-0 z-[80] bg-black/50 flex items-center justify-center p-4 backdrop-blur-sm" onClick={handleCloseModal}>
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-md p-6" onClick={(e) => e.stopPropagation()}>
                        <h3 className="text-xl font-bold border-b pb-3 mb-4 flex items-center gap-2" style={{ color: colors.primary }}>
                            {editingOrder ? <PenTool className="w-5 h-5" /> : <Plus className="w-5 h-5" />}
                            {editingOrder ? 'Edit Order' : 'Tambah Order Baru'}
                        </h3>
                        <form onSubmit={handleAddOrUpdateOrder} className="space-y-4">
                            <div>
                                <label className="text-sm font-semibold block mb-1">Nama Klien *</label>
                                <input 
                                    type="text" 
                                    value={newOrder.client} 
                                    onChange={(e) => setNewOrder({...newOrder, client: e.target.value})} 
                                    className="w-full p-2 border rounded-lg" required 
                                />
                            </div>
                            {/* PERBAIKAN 4: Kolom No Handphone */}
                            <div>
                                <label className="text-sm font-semibold block mb-1">No Handphone</label>
                                <input 
                                    type="tel" 
                                    value={newOrder.phone} 
                                    onChange={(e) => setNewOrder({...newOrder, phone: e.target.value})} 
                                    className="w-full p-2 border rounded-lg"
                                    placeholder="Contoh: 08123456789"
                                />
                            </div>
                            <div>
                                <label className="text-sm font-semibold block mb-1">Layanan/Deskripsi *</label>
                                <input 
                                    type="text" 
                                    value={newOrder.service} 
                                    onChange={(e) => setNewOrder({...newOrder, service: e.target.value})} 
                                    className="w-full p-2 border rounded-lg" required 
                                />
                            </div>
                            <div>
                                <label className="text-sm font-semibold block mb-1">Tanggal & Waktu *</label>
                                <input 
                                    type="datetime-local" 
                                    value={newOrder.date} 
                                    onChange={(e) => setNewOrder({...newOrder, date: e.target.value})} 
                                    className="w-full p-2 border rounded-lg" required 
                                />
                            </div>
                             <div>
                                <label className="text-sm font-semibold block mb-1">Status</label>
                                <Dropdown 
                                    value={newOrder.status} 
                                    onChange={(e) => setNewOrder({...newOrder, status: e.target.value})} 
                                    options={ORDER_STATUSES}
                                />
                            </div>
                            <div className="flex justify-end gap-3 pt-3">
                                <button type="button" onClick={handleCloseModal} className="px-4 py-2 border rounded-full text-gray-700 hover:bg-gray-100">Batal</button>
                                <button type="submit" className="px-4 py-2 rounded-full text-white font-bold" style={{ backgroundColor: colors.primary }}>
                                    {editingOrder ? 'Simpan Perubahan' : 'Simpan Order'}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            )}
            
            {/* PERBAIKAN 2: Custom Confirmation Modal untuk Delete */}
            {confirmDelete && (
                <div className="fixed inset-0 z-[90] bg-black/50 flex items-center justify-center p-4 backdrop-blur-sm" onClick={handleCloseModal}>
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-xs p-6 text-center" onClick={(e) => e.stopPropagation()}>
                        <AlertTriangle className="w-10 h-10 mx-auto mb-4 text-red-500" />
                        <h3 className="text-lg font-bold mb-2">Konfirmasi Hapus</h3>
                        <p className="text-sm text-gray-700 mb-6">Apakah Anda yakin ingin menghapus order dari klien: <strong>{confirmDelete.name}</strong>?</p>
                        <div className="flex justify-center gap-3">
                            <button 
                                type="button" 
                                onClick={handleCloseModal} 
                                className="px-4 py-2 border rounded-full text-gray-700 hover:bg-gray-100 flex-1"
                            >
                                Batal
                            </button>
                            <button 
                                type="button" 
                                onClick={() => handleDeleteOrder(confirmDelete.id)} 
                                className="px-4 py-2 rounded-full text-white font-bold bg-red-500 hover:bg-red-600 flex-1"
                            >
                                <Trash2 className="w-4 h-4 inline mr-1" /> Hapus
                            </button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
};

// --- MODULE: ITEM CHECKER ---

const ItemChecker = ({ colors, APP_LOGO_URL }) => {
    // Brand & Client Info (Mirip Invoice)
    const [brandLogoUrl, setBrandLogoUrl] = useState('');
    const [brandName, setBrandName] = useState('Hantaran Studio');
    const [brandContact, setBrandContact] = useState('Jl. Kenangan No. 1, Kota Lama\nWA: 0812-3456-7890');
    
    const [clientName, setClientName] = useState('');
    const [clientContact, setClientContact] = useState('');
    const [receiptDate, setReceiptDate] = useState(new Date().toISOString().slice(0, 10));
    const [receiptNo, setReceiptNo] = useState(`REC-${new Date().getFullYear()}-${Math.floor(Math.random() * 10000)}`);
    
    // Items Data: [{ id, name, qty, photos: [{ file, note }] }]
    const [items, setItems] = useState([
        { id: 1, name: '', qty: 1, photos: [] }
    ]);
    
    // Signatures
    const [brandSignature, setBrandSignature] = useState(null);
    const [clientSignature, setClientSignature] = useState(null);
    
    const [isGenerating, setIsGenerating] = useState(false);
    
    // --- OLD STATE/HANDLERS FOR MODAL REMOVED ---

    // Setup HTML2Canvas
    useEffect(() => {
        const scriptId = 'html2canvas-script';
        if (!document.getElementById(scriptId)) {
            const script = document.createElement('script');
            script.id = scriptId;
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
            script.async = true;
            document.body.appendChild(script);
        }
    }, []);

    // Handlers
    const handleLogoUpload = (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onloadend = () => setBrandLogoUrl(reader.result);
            reader.readAsDataURL(file);
        }
    };

    const handleAddItem = () => {
        setItems([...items, { id: Date.now(), name: '', qty: 1, photos: [] }]);
    };

    const handleRemoveItem = (id) => {
        if(items.length > 1) setItems(items.filter(i => i.id !== id));
    };

    const handleUpdateItem = (id, field, value) => {
        setItems(items.map(i => i.id === id ? { ...i, [field]: value } : i));
    };

    // Item Photo Handlers
    const handleAddItemPhoto = (itemId, files) => {
        const newPhotos = Array.from(files).map(file => ({
            file,
            url: URL.createObjectURL(file),
            note: ''
        }));
        
        setItems(items.map(i => {
            if (i.id === itemId) {
                return { ...i, photos: [...i.photos, ...newPhotos] };
            }
            return i;
        }));
    };

    const handleRemoveItemPhoto = (itemId, photoIndex) => {
         setItems(items.map(i => {
            if (i.id === itemId) {
                const newPhotos = i.photos.filter((_, idx) => idx !== photoIndex);
                return { ...i, photos: newPhotos };
            }
            return i;
        }));
    };

    const handleUpdatePhotoNote = (itemId, photoIndex, note) => {
         setItems(items.map(i => {
            if (i.id === itemId) {
                const newPhotos = [...i.photos];
                newPhotos[photoIndex] = { ...newPhotos[photoIndex], note };
                return { ...i, photos: newPhotos };
            }
            return i;
        }));
    };

    // PERBAIKAN DOWNLOAD 1: Pastikan elemen #checker-preview yang diambil
    // FIX MOBILE BLANK DOWNLOAD: Kloning dan pindahkan elemen ke luar layar jika tersembunyi
    const handleDownloadReport = async () => {
        if (!window.html2canvas) { console.error("Sistem sedang memuat html2canvas, coba lagi."); return; }
        setIsGenerating(true);
        
        const previewElement = document.getElementById('checker-preview');
        const filename = `TandaTerima - ${clientName || 'Client'}.png`;
        
        if (!previewElement) {
             console.error("Elemen preview tidak ditemukan.");
             setIsGenerating(false);
             return;
        }

        let elementToCapture = previewElement;
        let clone = null;
        
        // Cek apakah elemen preview disembunyikan oleh parent di mobile
        // Gunakan .closest() dengan class dari div yang tersembunyi ("hidden lg:block lg:w-1/2")
        const previewContainer = previewElement.closest('.lg\\:w-1\\/2');
        const isHidden = previewContainer && window.getComputedStyle(previewContainer).display === 'none';

        if (isHidden) {
            // Buat salinan (deep clone) element preview
            clone = previewElement.cloneNode(true);
            
            // Atur posisi agar tidak terlihat tetapi tetap bisa dirender oleh html2canvas
            clone.style.position = 'absolute';
            clone.style.top = '0';
            clone.style.left = '-9999px';
            clone.style.zIndex = '-1';
            clone.style.display = 'block'; // Pastikan terdisplay
            clone.style.transform = 'none';
            
            // Kita perlu memastikan semua style/classes dari elemen utama dipertahankan
            // (html2canvas seharusnya menangani ini, tapi clone harus berada di body)
            document.body.appendChild(clone);
            elementToCapture = clone;
        }

        try {
            // Force scroll to top to ensure full height capture
            window.scrollTo(0,0);
            
            // Menggunakan properti scale yang lebih tinggi untuk resolusi cetak yang lebih baik
            const canvas = await window.html2canvas(elementToCapture, { 
                scale: 3, 
                useCORS: true, 
                backgroundColor: '#ffffff' 
            });
            
            // Gunakan fungsi download aman untuk iOS
            safeDownload(canvas.toDataURL('image/png'), filename);
            
        } catch (error) {
            console.error("Download failed:", error);
        } finally {
            if (clone) {
                document.body.removeChild(clone); 
            }
            setIsGenerating(false);
        }
    };
    
    // --- OLD MODAL HANDLERS REMOVED ---


    return (
        <>
        <div className="flex flex-col lg:flex-row gap-6 h-full relative">
            {/* --- LEFT SIDE: INPUT --- */}
            <div className="w-full lg:w-1/2 flex flex-col gap-6 overflow-y-auto pr-2 pb-20">
                <h2 className="text-2xl font-bold flex items-center gap-2" style={{ color: colors.text }}>
                    <ClipboardCheck className="w-6 h-6" /> Pengecekan Barang
                </h2>

                {/* 1. Identity Config */}
                <div className="bg-white p-6 rounded-xl shadow-md border border-gray-200 space-y-4">
                    <h3 className="font-semibold text-gray-700 border-b pb-2 flex items-center gap-2">
                        <User className="w-4 h-4"/> Identitas
                    </h3>
                    
                    {/* Brand Section */}
                    <div className="p-4 bg-gray-50 rounded-lg space-y-3">
                         <div className="flex items-center gap-4">
                            <label className={`w-16 h-16 flex flex-col items-center justify-center border-2 border-dashed rounded-lg cursor-pointer bg-white hover:border-[${colors.primary}]`}>
                                <Upload className="w-4 h-4 text-gray-400" />
                                <span className="text-[9px] text-gray-400">Logo</span>
                                <input type="file" accept="image/*" className="hidden" onChange={handleLogoUpload} />
                            </label>
                            <div className="flex-1 space-y-2">
                                <input type="text" placeholder="Nama Brand / Vendor" className="w-full p-2 text-sm border rounded bg-white" value={brandName} onChange={e => setBrandName(e.target.value)} />
                                <input type="text" placeholder="Kontak / Alamat Brand" className="w-full p-2 text-xs border rounded bg-white" value={brandContact} onChange={e => setBrandContact(e.target.value)} />
                            </div>
                        </div>
                    </div>

                    {/* Client Section */}
                    <div className="space-y-3">
                        <div className="grid grid-cols-2 gap-3">
                            <input type="text" placeholder="Nama Klien" className="w-full p-2 text-sm border rounded" value={clientName} onChange={e => setClientName(e.target.value)} />
                             <input type="date" className="w-full p-2 text-sm border rounded" value={receiptDate} onChange={e => setReceiptDate(e.target.value)} />
                        </div>
                        <textarea placeholder="Alamat / Kontak Klien" className="w-full p-2 text-sm border rounded" rows="2" value={clientContact} onChange={e => setClientContact(e.target.value)} />
                        <div className="flex items-center gap-2">
                             <span className="text-xs text-gray-500">No. Tanda Terima:</span>
                             <input type="text" className="flex-1 p-1 text-xs border-b border-dashed font-mono bg-transparent" value={receiptNo} onChange={e => setReceiptNo(e.target.value)} />
                        </div>
                    </div>
                </div>

                {/* 2. Items List */}
                <div className="bg-white p-6 rounded-xl shadow-md border border-gray-200 space-y-4">
                    <div className="flex justify-between items-center border-b pb-2">
                        <h3 className="font-semibold text-gray-700 flex items-center gap-2">
                            <Box className="w-4 h-4"/> Daftar Barang
                        </h3>
                        <button onClick={handleAddItem} className="text-xs flex items-center gap-1 bg-green-100 text-green-700 px-3 py-1.5 rounded-full hover:bg-green-200 transition">
                            <Plus className="w-3 h-3" /> Tambah Barang
                        </button>
                    </div>

                    <div className="space-y-6">
                        {items.map((item, index) => (
                            <div key={item.id} className="border rounded-xl p-4 bg-gray-50 relative group">
                                <button onClick={() => handleRemoveItem(item.id)} className="absolute top-2 right-2 text-gray-400 hover:text-red-500 p-1">
                                    <Trash2 className="w-4 h-4" />
                                </button>
                                
                                {/* PERBAIKAN MOBILE: Ubah grid-cols-12 menjadi stack di mobile */}
                                <div className="grid grid-cols-1 md:grid-cols-12 gap-3 mb-3">
                                    <div className="col-span-1 md:col-span-1 flex items-center justify-start md:justify-center font-bold text-gray-400">
                                        <span className="md:hidden mr-2">Item</span>{index + 1}.
                                    </div>
                                    <div className="col-span-1 md:col-span-8">
                                        <label className="text-[10px] text-gray-500 font-bold uppercase">Nama Barang</label>
                                        <input 
                                            type="text" 
                                            placeholder="Contoh: Sepatu Hak Tinggi" 
                                            className="w-full p-2 text-sm border rounded bg-white"
                                            value={item.name}
                                            onChange={(e) => handleUpdateItem(item.id, 'name', e.target.value)}
                                        />
                                    </div>
                                    <div className="col-span-1 md:col-span-3">
                                        <label className="text-[10px] text-gray-500 font-bold uppercase">Jumlah</label>
                                        <input 
                                            type="number" 
                                            min="1"
                                            className="w-full p-2 text-sm border rounded bg-white text-center"
                                            value={item.qty}
                                            onChange={(e) => handleUpdateItem(item.id, 'qty', parseInt(e.target.value) || 0)}
                                        />
                                    </div>
                                </div>

                                {/* Photo Evidence Section */}
                                <div className="bg-white p-3 rounded-lg border border-dashed border-gray-300">
                                    <div className="flex justify-between items-center mb-2">
                                        <span className="text-xs text-gray-500 font-semibold flex items-center gap-1">
                                            <Camera className="w-3 h-3" /> Bukti Foto Kondisi
                                        </span>
                                        <label className="cursor-pointer text-xs text-blue-600 hover:underline flex items-center gap-1">
                                            <Plus className="w-3 h-3" /> Upload Foto
                                            <input type="file" multiple accept="image/*" className="hidden" onChange={(e) => handleAddItemPhoto(item.id, e.target.files)} />
                                        </label>
                                    </div>
                                    
                                    {item.photos.length > 0 ? (
                                        // PERBAIKAN 2: Ubah grid-cols-3 menjadi grid-cols-2 di mobile untuk menambah ruang catatan
                                        <div className="grid grid-cols-2 md:grid-cols-3 gap-2 mt-2">
                                            {item.photos.map((photo, pIdx) => (
                                                <div key={pIdx} className="relative border rounded-lg overflow-hidden bg-gray-50">
                                                    {/* PERBAIKAN 2: Mengubah object-cover menjadi object-contain untuk menghindari pemotongan gambar */}
                                                    <div className="aspect-[4/3] w-full bg-gray-200 mb-1 overflow-hidden rounded-sm flex items-center justify-center">
                                                        <img src={photo.url} className="w-full h-full object-contain" alt="Evidence" />
                                                    </div>
                                                    <input 
                                                        type="text" 
                                                        placeholder="Catatan (mis: lecet, noda)" 
                                                        // PERBAIKAN 2: Penyesuaian ukuran input
                                                        className="w-full px-2 py-1.5 text-sm bg-transparent border-t outline-none"
                                                        value={photo.note}
                                                        onChange={(e) => handleUpdatePhotoNote(item.id, pIdx, e.target.value)}
                                                    />
                                                </div>
                                            ))}
                                        </div>
                                    ) : (
                                        <div className="text-center py-3 text-xs text-gray-400 italic">Belum ada foto bukti</div>
                                    )}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>

                {/* 3. Signatures */}
                <div className="bg-white p-6 rounded-xl shadow-md border border-gray-200 space-y-4">
                    <h3 className="font-semibold text-gray-700 border-b pb-2 flex items-center gap-2">
                        <PenTool className="w-4 h-4"/> Tanda Tangan
                    </h3>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                         {/* PERBAIKAN 3: Menggunakan SignaturePad yang sudah dimodifikasi tanpa modal */}
                        <SignaturePad 
                            label={`Pihak ${brandName || 'Vendor'}`}
                            signatureData={brandSignature}
                            onSave={setBrandSignature}
                            onClear={() => setBrandSignature(null)}
                            colors={colors}
                        />
                         {/* PERBAIKAN 3: Menggunakan SignaturePad yang sudah dimodifikasi tanpa modal */}
                        <SignaturePad 
                            label={`Pihak Klien (${clientName || 'Pelanggan'})`}
                            signatureData={clientSignature}
                            onSave={setClientSignature}
                            onClear={() => setClientSignature(null)}
                            colors={colors}
                        />
                    </div>
                </div>
            </div>

            {/* --- RIGHT SIDE: PREVIEW --- */}
            {/* PERBAIKAN 1: Sembunyikan di mobile (hidden) dan hanya tampil di layar besar (lg:block) */}
            <div className="hidden lg:block lg:w-1/2 bg-gray-100 p-4 rounded-xl overflow-y-auto flex flex-col items-center relative pb-20">
                 {/* DOWNLOAD BUTTON DIPINDAH KELUAR */}

                {/* DYNAMIC PAPER PREVIEW */}
                {/* PERBAIKAN MOBILE: Tambahkan overflow-x-auto untuk container preview */}
                <div className="w-full overflow-x-auto">
                    <div id="checker-preview" className="bg-white w-[210mm] min-w-[210mm] h-auto p-10 shadow-2xl text-sm text-gray-800 relative mt-4 lg:mt-0 box-border flex flex-col mx-auto">
                        
                        {/* Header */}
                        <div className="flex justify-between items-start border-b-2 border-gray-800 pb-4 mb-6">
                            <div className="flex gap-4 items-center">
                                <img src={brandLogoUrl || APP_LOGO_URL} className="w-16 h-16 object-contain" alt="Logo" />
                                <div>
                                    <h1 className="text-2xl font-bold uppercase tracking-wider" style={{ color: colors.text }}>BERITA ACARA</h1>
                                    <p className="text-sm font-semibold text-gray-500 uppercase tracking-widest">Penerimaan Barang Hantaran</p>
                                </div>
                            </div>
                            <div className="text-right">
                                <div className="text-xl font-bold font-mono text-gray-600">{receiptNo}</div>
                                <p className="text-sm text-gray-500">{new Date(receiptDate).toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}</p>
                            </div>
                        </div>

                        {/* Parties */}
                        <div className="grid grid-cols-2 gap-8 mb-8">
                            <div>
                                <p className="text-xs text-gray-500 uppercase font-bold mb-1">Diterima Oleh (Vendor)</p>
                                <p className="font-bold text-lg">{brandName}</p>
                                <p className="text-xs text-gray-600 whitespace-pre-wrap">{brandContact}</p>
                            </div>
                            <div className="text-right">
                                 <p className="text-xs text-gray-500 uppercase font-bold mb-1">Diserahkan Oleh (Klien)</p>
                                 <p className="font-bold text-lg">{clientName || '....................'}</p>
                                 <p className="text-xs text-gray-600 whitespace-pre-wrap">{clientContact || '....................'}</p>
                            </div>
                        </div>

                        {/* Disclaimer Text */}
                        <div className="bg-gray-50 border-l-4 p-3 text-xs text-gray-600 italic mb-6" style={{ borderColor: colors.secondary }}>
                            Dengan ini kedua belah pihak menyatakan bahwa barang-barang di bawah ini telah diserahkan dan diterima dalam kondisi sebagaimana didokumentasikan dalam foto terlampir. Segala cacat yang tercatat menjadi bukti kondisi awal penerimaan.
                        </div>

                        {/* Items & Photos Table */}
                        <div className="mb-8">
                            <table className="w-full border-collapse">
                                <thead>
                                    <tr className="border-b-2 border-gray-800">
                                        <th className="text-left py-2 w-10">#</th>
                                        <th className="text-left py-2">Nama Barang & Bukti Kondisi</th>
                                        <th className="text-center py-2 w-20">Qty</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {items.map((item, idx) => (
                                        <tr key={item.id} className="border-b border-gray-100 align-top">
                                            <td className="py-4 font-bold text-gray-500">{idx + 1}</td>
                                            <td className="py-4">
                                                <div className="font-bold text-base mb-2">{item.name || 'Nama Barang Belum Diisi'}</div>
                                                
                                                {/* Photo Grid within Table */}
                                                {item.photos.length > 0 && (
                                                    <div className="grid grid-cols-3 gap-2 mt-2">
                                                        {item.photos.map((photo, pIdx) => (
                                                            <div key={pIdx} className="relative border rounded-lg overflow-hidden bg-gray-50">
                                                                {/* PERBAIKAN 2: Mengubah object-cover menjadi object-contain di preview dokumen */}
                                                                <div className="aspect-[4/3] w-full bg-gray-200 mb-1 overflow-hidden rounded-sm flex items-center justify-center">
                                                                    <img src={photo.url} className="w-full h-full object-contain" alt="Evidence" />
                                                                </div>
                                                                <p className="text-[10px] text-gray-600 leading-tight min-h-[2.5em]">
                                                                    {photo.note ? `"${photo.note}"` : '-'}
                                                                </p>
                                                            </div>
                                                        ))}
                                                    </div>
                                                )}
                                            </td>
                                            <td className="py-4 text-center font-bold">{item.qty}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>

                        {/* Signatures Footer */}
                        <div className="pt-8 border-t-2 border-gray-800">
                            <div className="grid grid-cols-2 gap-20 text-center">
                                <div>
                                    <p className="text-xs font-bold uppercase mb-4">Pihak Vendor</p>
                                    <div className="h-24 flex items-center justify-center mb-2">
                                        {brandSignature ? <img src={brandSignature} className="h-full object-contain" alt="Sig" /> : <div className="text-gray-200 text-xs italic">Tanda Tangan Digital</div>}
                                    </div>
                                    <p className="font-bold border-t border-gray-300 pt-1 inline-block min-w-[150px]">{brandName}</p>
                                </div>
                                <div>
                                    <p className="text-xs font-bold uppercase mb-4">Pihak Klien</p>
                                    <div className="h-24 flex items-center justify-center mb-2">
                                        {clientSignature ? <img src={clientSignature} className="h-full object-contain" alt="Sig" /> : <div className="text-gray-200 text-xs italic">Tanda Tangan Digital</div>}
                                    </div>
                                    <p className="font-bold border-t border-gray-300 pt-1 inline-block min-w-[150px]">{clientName || 'Nama Terang'}</p>
                                </div>
                            </div>

                            {/* Logo dan Teks Footer Baru */}
                            <div className="mt-8 flex flex-col items-center">
                                <img src={brandLogoUrl || APP_LOGO_URL} className="w-12 h-12 object-contain mb-2" alt="App Logo" />
                                <div className="text-center text-[10px] text-gray-400">
                                    Dokumen ini dibuat secara digital melalui <span className="font-extrabold text-gray-700">HANTARAN STUDIO</span> App pada {new Date().toLocaleString('id-ID')}
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
        
        {/* DOWNLOAD BUTTON - Dipindahkan keluar dari div preview agar muncul di mobile */}
        <button
            onClick={handleDownloadReport}
            disabled={isGenerating}
            className="fixed bottom-8 right-8 z-40 p-4 rounded-full shadow-2xl transition hover:scale-110 flex items-center justify-center cursor-pointer hover:shadow-green-200"
            style={{ backgroundColor: colors.primary, color: 'white' }}
            title="Unduh Laporan (PNG)"
        >
            {isGenerating ? <div className="w-6 h-6 border-2 border-white border-t-transparent rounded-full animate-spin"></div> : <Download className="w-6 h-6" />}
        </button>

        {/* --- Signature Modal Render (Dihapus dari sini) --- */}
        </>
    );
};

// --- MODULE: INVOICE MAKER (Updated) ---

const InvoiceMaker = ({ colors, APP_LOGO_URL }) => {
    const [brandLogoUrl, setBrandLogoUrl] = useState('');
    const [brandName, setBrandName] = useState('Nama Brand Anda');
    const [brandContactAddress, setBrandContactAddress] = useState('Alamat Lengkap\nKontak: +62 123 4567');
    const [brandInstagram, setBrandInstagram] = useState('@instagram_anda');
    const [brandTiktok, setBrandTiktok] = useState('@tiktok_anda');
    const [clientName, setClientName] = useState('');
    const [clientAddress, setClientAddress] = useState('');
    const [invoiceNumber, setInvoiceNumber] = useState(`INV-${new Date().getFullYear()}-${Math.floor(Math.random() * 1000)}`);
    const [invoiceDate, setInvoiceDate] = useState(new Date().toISOString().slice(0, 10));
    const [items, setItems] = useState([{ id: 1, desc: '', qty: 1, price: 0 }]);
    const [notes, setNotes] = useState('Terima kasih atas kepercayaan Anda.');
    const [isImageGenerating, setIsImageGenerating] = useState(false);

    useEffect(() => {
        const scriptId = 'html2canvas-script';
        if (!document.getElementById(scriptId)) {
            const script = document.createElement('script');
            script.id = scriptId;
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
            script.async = true;
            document.body.appendChild(script);
        }
    }, []);

    const addItem = () => setItems([...items, { id: Date.now(), desc: '', qty: 1, price: 0 }]);
    const removeItem = (id) => { if (items.length > 1) setItems(items.filter(item => item.id !== id)); };
    const updateItem = (id, field, value) => setItems(items.map(item => item.id === id ? { ...item, [field]: value } : item));
    const subtotal = items.reduce((sum, item) => sum + (item.qty * item.price), 0);
    const total = subtotal;
    const formatRupiah = (number) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(number);

    // PERBAIKAN DOWNLOAD 2: Pastikan elemen #invoice-preview yang diambil
    // FIX MOBILE BLANK DOWNLOAD: Kloning dan pindahkan elemen ke luar layar jika tersembunyi
    const handleDownloadImage = async () => {
        if (!window.html2canvas) { console.error("Sedang memuat modul gambar, silakan coba 2 detik lagi."); return; }
        setIsImageGenerating(true);
        
        const previewElement = document.getElementById('invoice-preview');
        const filename = `Invoice - ${brandName || 'Brand'} - ${clientName || 'Customer'}.png`;
        
        if (!previewElement) {
             console.error("Elemen preview tidak ditemukan.");
             setIsImageGenerating(false);
             return;
        }

        let elementToCapture = previewElement;
        let clone = null;
        
        // Cek apakah elemen preview disembunyikan oleh parent di mobile
        const previewContainer = previewElement.closest('.lg\\:w-1\\/2');
        const isHidden = previewContainer && window.getComputedStyle(previewContainer).display === 'none';

        if (isHidden) {
            // Buat salinan (deep clone) element preview
            clone = previewElement.cloneNode(true);
            
            // Atur posisi agar tidak terlihat tetapi tetap bisa dirender oleh html2canvas
            clone.style.position = 'absolute';
            clone.style.top = '0';
            clone.style.left = '-9999px';
            clone.style.zIndex = '-1';
            clone.style.display = 'block'; // Pastikan terdisplay
            clone.style.transform = 'none';

            document.body.appendChild(clone);
            elementToCapture = clone;
        }

        try {
            // Force scroll to top (walaupun tidak mutlak perlu di modul ini)
            window.scrollTo(0,0);
            
            const canvas = await window.html2canvas(elementToCapture, { 
                scale: 3, 
                useCORS: true, 
                backgroundColor: '#ffffff' 
            });
            
            // Gunakan fungsi download aman untuk iOS
            safeDownload(canvas.toDataURL('image/png'), filename);
            
        } catch (error) {
            console.error("Gagal membuat gambar:", error);
        } finally {
            if (clone) {
                document.body.removeChild(clone);
            }
            setIsImageGenerating(false);
        }
    };

    const handleLogoUpload = (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onloadend = () => setBrandLogoUrl(reader.result);
            reader.readAsDataURL(file);
        }
    };

    return (
        <div className="flex flex-col lg:flex-row gap-6 h-full relative">
            <div className="w-full lg:w-1/2 flex flex-col gap-6 overflow-y-auto pr-2 pb-20">
                <h2 className="text-2xl font-bold" style={{ color: colors.text }}><FileText className="inline-block w-6 h-6 mr-2" />Buat Invoice</h2>
                <div className="bg-white p-6 rounded-xl shadow-md border border-gray-200 space-y-4">
                    <h3 className="font-semibold text-gray-700 border-b pb-2">Info Brand (Penyedia Jasa)</h3>
                    <div className="grid gap-3">
                        <div className="flex items-center gap-4">
                            <label className={`w-20 h-20 flex items-center justify-center border-2 border-dashed rounded-lg cursor-pointer hover:border-[${colors.primary}]`}>
                                <Upload className="w-5 h-5 text-gray-500" /><input type="file" accept="image/*" className="hidden" onChange={handleLogoUpload} />
                            </label>
                            {brandLogoUrl && <img src={brandLogoUrl} alt="Brand Logo Preview" className="w-20 h-20 object-contain" />}
                            <div>
                                <label className="text-xs text-gray-500">URL Logo Brand</label>
                                <input type="text" placeholder="Tempel URL Logo Brand (Opsional)" className="w-full p-2 border rounded-lg text-sm" value={brandLogoUrl} onChange={(e) => setBrandLogoUrl(e.target.value)} />
                            </div>
                        </div>
                        <input type="text" placeholder="Nama Brand" className="w-full p-2 border rounded-lg text-sm font-bold" value={brandName} onChange={(e) => setBrandName(e.target.value)} />
                        <textarea placeholder="Alamat dan Kontak Brand" className="w-full p-2 border rounded-lg text-sm" rows="2" value={brandContactAddress} onChange={(e) => setBrandContactAddress(e.target.value)} />
                        <div className="grid grid-cols-2 gap-3">
                            <input type="text" placeholder="Instagram (@username)" className="w-full p-2 border rounded-lg text-sm" value={brandInstagram} onChange={(e) => setBrandInstagram(e.target.value)} />
                            <input type="text" placeholder="Tiktok (@username)" className="w-full p-2 border rounded-lg text-sm" value={brandTiktok} onChange={(e) => setBrandTiktok(e.target.value)} />
                        </div>
                    </div>
                </div>

                <div className="bg-white p-6 rounded-xl shadow-md border border-gray-200 space-y-4">
                    <h3 className="font-semibold text-gray-700 border-b pb-2">Info Pelanggan</h3>
                    <div className="grid gap-3">
                        <input type="text" placeholder="Nama Klien / Pasangan" className="w-full p-2 border rounded-lg text-sm" value={clientName} onChange={(e) => setClientName(e.target.value)} />
                        <textarea placeholder="Alamat / Kontak" className="w-full p-2 border rounded-lg text-sm" rows="2" value={clientAddress} onChange={(e) => setClientAddress(e.target.value)} />
                    </div>
                </div>

                <div className="bg-white p-6 rounded-xl shadow-md border border-gray-200 space-y-4">
                    <h3 className="font-semibold text-gray-700 border-b pb-2">Detail Invoice</h3>
                    <div className="grid grid-cols-2 gap-3">
                        <div><label className="text-xs text-gray-500">No. Invoice</label><input type="text" className="w-full p-2 border rounded-lg text-sm font-mono" value={invoiceNumber} onChange={(e) => setInvoiceNumber(e.target.value)} /></div>
                        <div><label className="text-xs text-gray-500">Tanggal</label><input type="date" className="w-full p-2 border rounded-lg text-sm" value={invoiceDate} onChange={(e) => setInvoiceDate(e.target.value)} /></div>
                    </div>
                </div>

                <div className="bg-white p-6 rounded-xl shadow-md border border-gray-200 space-y-4">
                    <div className="flex justify-between items-center border-b pb-2">
                        <h3 className="font-semibold text-gray-700">Daftar Layanan/Barang</h3>
                        <button onClick={addItem} className="text-xs flex items-center gap-1 bg-green-100 text-green-700 px-2 py-1 rounded hover:bg-green-200"><Plus className="w-3 h-3" /> Tambah</button>
                    </div>
                    <div className="space-y-3">
                        {items.map((item) => (
                            // PERBAIKAN MOBILE: Gunakan flex-wrap/col untuk layar kecil
                            <div key={item.id} className="flex flex-col md:flex-row gap-2 items-start bg-gray-50 p-2 rounded-lg md:bg-transparent md:p-0">
                                <div className="w-full md:flex-1">
                                    <input type="text" placeholder="Deskripsi (mis: Hantaran Box Acrylic)" className="w-full p-2 border rounded-lg text-sm" value={item.desc} onChange={(e) => updateItem(item.id, 'desc', e.target.value)} />
                                </div>
                                <div className="flex gap-2 w-full md:w-auto">
                                    <div className="w-1/3 md:w-16">
                                        <input type="number" placeholder="Qty" className="w-full p-2 border rounded-lg text-sm text-center" value={item.qty} min="1" onChange={(e) => updateItem(item.id, 'qty', parseInt(e.target.value) || 0)} />
                                    </div>
                                    <div className="w-2/3 md:w-28">
                                        <input type="number" placeholder="Harga" className="w-full p-2 border rounded-lg text-sm text-right" value={item.price} onChange={(e) => updateItem(item.id, 'price', parseInt(e.target.value) || 0)} />
                                    </div>
                                    <button onClick={() => removeItem(item.id)} className="p-2 text-red-400 hover:text-red-600"><Trash2 className="w-4 h-4" /></button>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>

                 <div className="bg-white p-6 rounded-xl shadow-md border border-gray-200 space-y-4">
                    <h3 className="font-semibold text-gray-700 border-b pb-2">Catatan Kaki</h3>
                    <textarea className="w-full p-2 border rounded-lg text-sm" rows="2" value={notes} onChange={(e) => setNotes(e.target.value)} />
                </div>
            </div>

            {/* PERBAIKAN 1: Sembunyikan di mobile (hidden) dan hanya tampil di layar besar (lg:block) */}
            <div className="hidden lg:block lg:w-1/2 bg-gray-100 p-4 rounded-xl overflow-y-auto flex flex-col items-center relative pb-20">
                {/* DOWNLOAD BUTTON DIPINDAH KELUAR */}
                
                {/* PERBAIKAN MOBILE: Container overflow-x-auto untuk preview */}
                <div className="w-full overflow-x-auto">
                    <div id="invoice-preview" className="bg-white w-[210mm] min-w-[210mm] min-h-[297mm] p-8 shadow-2xl text-sm leading-relaxed text-gray-800 relative mt-4 lg:mt-0 box-border mx-auto">
                        <div className="flex justify-between items-start mb-8">
                            <div>
                                 <h1 className="text-3xl font-bold tracking-wide" style={{ color: colors.primary }}>INVOICE</h1>
                                 <p className="font-bold mt-2 text-lg">{brandName || 'Nama Brand Anda'}</p>
                                 <p className="text-gray-500 text-xs whitespace-pre-wrap">{brandContactAddress || 'Alamat dan Kontak Brand'}</p>
                                 {brandInstagram && <p className="text-gray-500 text-xs">IG: {brandInstagram}</p>}
                                 {brandTiktok && <p className="text-gray-500 text-xs">TT: {brandTiktok}</p>}
                            </div>
                            <div className="text-right">
                                 <img src={brandLogoUrl || APP_LOGO_URL} alt="Brand Logo" className="w-16 h-16 object-contain ml-auto mb-2" crossOrigin="anonymous" />
                                 <p className="font-mono text-gray-600">#{invoiceNumber}</p>
                                 <p className="text-gray-500">{new Date(invoiceDate).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' })}</p>
                            </div>
                        </div>
                        <div className="mb-8 border-b pb-4">
                            <p className="text-gray-500 text-xs uppercase font-bold mb-1">Ditagihkan Kepada:</p>
                            <h3 className="text-lg font-bold">{clientName || 'Nama Pelanggan'}</h3>
                            <p className="text-gray-600 whitespace-pre-wrap">{clientAddress || 'Alamat Pelanggan'}</p>
                        </div>
                        <table className="w-full mb-8 border-collapse">
                            <thead>
                                <tr className="border-b-2 border-gray-800">
                                    <th className="text-left py-2 font-bold uppercase text-xs">Deskripsi</th>
                                    <th className="text-center py-2 font-bold uppercase text-xs w-16">Qty</th>
                                    <th className="text-right py-2 font-bold uppercase text-xs w-32">Harga</th>
                                    <th className="text-right py-2 font-bold uppercase text-xs w-32">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                {items.map((item) => (
                                    <tr key={item.id} className="border-b border-gray-100">
                                        <td className="py-3">{item.desc}</td>
                                        <td className="py-3 text-center">{item.qty}</td>
                                        <td className="py-3 text-right">{formatRupiah(item.price)}</td>
                                        <td className="py-3 text-right font-medium">{formatRupiah(item.qty * item.price)}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                        <div className="flex justify-end mb-12">
                            <div className="w-1/2">
                                <div className="flex justify-between py-2 border-b"><span className="font-semibold">Subtotal</span><span>{formatRupiah(subtotal)}</span></div>
                                <div className="flex justify-between py-2 text-xl font-bold text-gray-900 mt-2"><span>Total</span><span>{formatRupiah(total)}</span></div>
                            </div>
                        </div>
                        {/* PERBAIKAN: Memindahkan logo di atas teks dan menyesuaikan ukuran */}
                        <div className="absolute bottom-8 left-8 right-8">
                             <div className="bg-gray-50 p-4 rounded-lg border border-gray-100"><p className="font-bold text-xs mb-1">Catatan:</p><p className="text-gray-600 text-xs italic">{notes}</p></div>
                             
                             {/* FOOTER BARU DENGAN LOGO DI ATAS */}
                             <div className="text-center text-xs text-gray-400 mt-6 flex flex-col items-center gap-1">
                                <img src={brandLogoUrl || APP_LOGO_URL} alt="App Logo" className="w-12 h-12 object-contain mb-1" crossOrigin="anonymous" />
                                <p className="flex items-center gap-1">This invoice is generated by
                                    <span className="font-extrabold text-gray-700">HANTARAN STUDIO</span>
                                </p>
                             </div>
                        </div>
                    </div>
                </div>
            </div>
            {/* DOWNLOAD BUTTON - Dipindahkan keluar dari div preview agar muncul di mobile */}
            <button
                onClick={handleDownloadImage}
                disabled={isImageGenerating}
                className="fixed bottom-8 right-8 z-40 p-4 rounded-full shadow-2xl transition hover:scale-110 flex items-center justify-center cursor-pointer hover:shadow-green-200"
                style={{ backgroundColor: colors.primary, color: 'white' }}
                title="Simpan Invoice sebagai Gambar (PNG)"
            >
                {isImageGenerating ? <div className="w-6 h-6 border-2 border-white border-t-transparent rounded-full animate-spin"></div> : <Download className="w-6 h-6" />}
            </button>
        </div>
    );
};

// --- MODUL BARU: FLOWER BOUQUET ---

const FlowerBouquetForm = ({ onGenerate, isGenerating, colors }) => {
    
    // --- PERUBAHAN DI SINI: Inisialisasi default dengan isAuto: true ---
    const initialConfig = useMemo(() => {
        const config = {};
        Object.keys(PRESET_OPTIONS.bouquet).forEach(key => {
            config[key] = { value: '', isAuto: true }; // Default to Auto
        });
        return config;
    }, []);

    const [bouquetConfig, setBouquetConfig] = useState(initialConfig);
    // --- AKHIR PERUBAHAN ---

    const toggleAuto = (key) => {
        setBouquetConfig(prev => ({ ...prev, [key]: { ...prev[key], isAuto: !prev[key].isAuto } }));
    };

    const handleChange = (key, val) => {
        setBouquetConfig(prev => ({ ...prev, [key]: { ...prev[key], value: val } }));
    };

    const handleAutoFill = () => {
        const newConfig = { ...bouquetConfig };
        Object.keys(newConfig).forEach(key => newConfig[key].isAuto = true);
        setBouquetConfig(newConfig);
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        onGenerate({ start: true });

        const apiKey = ""; 
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`;

        try {
            // Cek apakah ada nilai spesifik yang dipilih pengguna (bukan auto dan bukan kosong)
            const hasExplicitValue = Object.values(bouquetConfig).some(conf => !conf.isAuto && conf.value !== '');

            const promises = [1, 2].map(async (i) => {
                 // Generate Prompt for each variation
                let prompt = `
                **PROFESSIONAL FLORIST PHOTOGRAPHY - BOUQUET VARIATION ${i}**
                Generate a photorealistic, high-end 8k image of a Flower Bouquet.

                **SPECIFICATIONS:**
                `;
                
                Object.keys(bouquetConfig).forEach(key => {
                     const conf = bouquetConfig[key];
                     prompt += `- **${key}:** ${conf.isAuto ? "Creative & Aesthetic Choice" : conf.value}\n`;
                });

                // --- FIX: Tambahkan fallback deskriptif jika tidak ada pilihan yang ditentukan ---
                if (!hasExplicitValue) {
                    prompt += `
                    **FALLBACK STYLE (Since no explicit choice):** Design a sophisticated, elegant, hand-tied bridal bouquet. Use a combination of soft white and blush pink Peonies and Garden Roses, accented with abundant sage greenery. The binding must be a luxurious raw silk ribbon in a neutral tone. The wrapping should be minimalist and airy (Korean style paper).
                    `;
                }
                // --- END FIX ---

                // --- PERUBAHAN PENTING: Variasi Pencahayaan & Komposisi ---
                prompt += `
                **ENVIRONMENT:**
                `;
                
                if (i === 1) {
                    prompt += `
                    - **Background:** Soft, neutral studio background (light grey or cream) to highlight the flowers.
                    - **Lighting:** Soft natural window light.
                    - **Composition:** Centered, showing the full bouquet arrangement.
                    `;
                } else {
                    prompt += `
                    - **Background:** Darker, textured backdrop (velvet or moody concrete) or a sunlit outdoor setting (Golden Hour).
                    - **Lighting:** Dramatic, directional light (e.g., single spotlight or warm evening sun).
                    - **Composition:** Dynamic, slightly off-center, with more depth of field (bokeh).
                    `;
                }
                // --- AKHIR PERUBAHAN PENTING ---

                prompt += `
                **QUALITY:** Sharp focus, vibrant colors, detailed textures of petals and wrapping paper.
                `;

                const response = await fetchWithRetry(url, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: prompt }] }], generationConfig: { responseModalities: ['IMAGE'] } }) 
                });

                if (!response.ok) { console.error(`API response not OK for Bouquet var ${i}.`); return null; }

                const result = await response.json();
                const base64 = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
                
                // FIX: Menambahkan pengecekan base64 dan logging finishReason
                if (!base64) {
                    const finishReason = result?.candidates?.[0]?.finishReason;
                    const error = result?.error?.message || 'Unknown API failure.';
                    console.error(`Bouquet gen failed for variation ${i}. Reason: ${finishReason || 'Missing Data'}. Error detail: ${error}. Response:`, result);
                }
                
                return base64 ? `data:image/png;base64,${base64}` : null;
            });
            
            const results = await Promise.all(promises);
            const validImages = results.filter(r => r !== null);

            if (validImages.length === 0) throw new Error("Gambar tidak ditemukan.");

            onGenerate({ data: { images: validImages }, start: false });

        } catch (error) {
            console.error(error);
            onGenerate({ start: false });
            // Menghapus alert()
        }
    };

    return (
        <form onSubmit={handleSubmit} className="flex flex-col gap-6 p-4 md:p-6">
            <h2 className="text-3xl font-bold text-center mb-4" style={{ color: colors.text }}>Bouquet Designer</h2>
            
             <div className="flex justify-end">
                <button type="button" onClick={handleAutoFill} className="flex items-center gap-2 px-4 py-2 rounded-full text-white text-sm font-bold shadow-md hover:shadow-lg transition transform hover:scale-105" style={{ background: `linear-gradient(90deg, ${colors.accent} 0%, ${colors.supporting} 100%)` }}>
                    <Sparkles className="w-4 h-4" /> AI Auto Fill
                </button>
            </div>

            <section className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {['Theme', 'Style', 'ColorPalette', 'FlowerCombination', 'Binding', 'Wrapper'].map(key => (
                    <InputGroup key={key} label={key.replace(/([A-Z])/g, ' $1').trim()} isAuto={bouquetConfig[key].isAuto || false} onToggleAuto={() => toggleAuto(key)}>
                        <Dropdown value={bouquetConfig[key].value || ''} onChange={(e) => handleChange(key, e.target.value)} options={PRESET_OPTIONS.bouquet[key]} disabled={bouquetConfig[key].isAuto} />
                    </InputGroup>
                ))}
            </section>

             <div className="w-full md:w-2/3 lg:w-1/2 mx-auto h-14 mt-4">
                 {isGenerating ? (
                    <div className="flex justify-center items-center h-full">
                         <svg className="animate-spin h-10 w-10" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke={colors.primary} strokeWidth="4" fill="none" className="opacity-25" /><path d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" fill={colors.secondary} /></svg>
                    </div>
                ) : (
                    <button type="submit" className={`w-full py-3 px-8 text-lg font-bold text-white rounded-full transition-all duration-300 shadow-xl h-full flex items-center justify-center gap-2 hover:scale-105`} style={{ background: `linear-gradient(90deg, ${colors.primary} 0%, ${colors.supporting} 100%)` }}>
                        Buat Buket
                    </button>
                )}
            </div>
        </form>
    );
};

const FlowerBouquetResults = ({ results, isLoading, colors, setEditContext }) => {
    // MODIFIKASI: Menggunakan struktur grid dan modal yang mirip dengan MaharDesignResults/MagicPhotoResults
    const images = results?.data?.images || [];
    const [viewIndex, setViewIndex] = useState(0);
    const [isModalOpen, setIsModalOpen] = useState(false);

    const handleDownload = (url, index) => {
        safeDownload(url, `Bouquet-Var${index+1}-${Date.now()}.png`);
    };
    
    // Fungsi untuk membuka modal edit
    const handleEdit = (image, index) => {
        setEditContext({ image, index, layout: '1:1 (Square)' }); // Layout default square
    };

    if (isLoading) return <div className="p-8 h-full flex flex-col justify-center"><SkeletonLoading primaryColor={colors.primary} secondaryColor={colors.secondary} bgColor={colors.bg} /></div>;
    
    if (images.length === 0) return (
        <div className="flex flex-col items-center justify-center h-full min-h-[500px] p-8 text-center" style={{ color: colors.text }}>
            <Flower className="w-20 h-20 mb-4 opacity-30" />
            <h3 className="text-xl font-semibold mb-2">Belum Ada Buket</h3>
            <p className="text-gray-500">Hasil desain buket Anda akan muncul di sini.</p>
        </div>
    );

    return (
        <div className="p-6 flex flex-col">
            <h2 className="text-2xl font-bold text-center mb-6" style={{ color: colors.text }}>Hasil Desain Buket</h2>
            
            <div className="flex-1 grid grid-cols-1 md:grid-cols-2 gap-6 items-start">
                {images.map((img, idx) => (
                    <div key={idx} className="group relative aspect-square rounded-2xl overflow-hidden shadow-xl border-4 bg-white cursor-pointer transition duration-300" style={{ borderColor: idx === viewIndex ? colors.primary : 'transparent' }}>
                        <img src={img} alt={`Bouquet ${idx+1}`} className="w-full h-full object-cover" />
                         {/* Tombol Maximize, Download, dan Edit (Meniru Magic Photo) */}
                        <div className="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition flex items-center justify-center gap-3">
                            <button onClick={() => { setViewIndex(idx); setIsModalOpen(true); }} className="p-2 bg-white/20 backdrop-blur rounded-full text-white hover:bg-white/40" title="Lihat"><Maximize2 className="w-5 h-5" /></button>
                            <button onClick={() => handleDownload(img, idx)} className="p-2 bg-white/20 backdrop-blur rounded-full text-white hover:bg-white/40" title="Download"><Download className="w-5 h-5" /></button>
                            <button onClick={() => handleEdit(img, idx)} className="p-2 bg-white/20 backdrop-blur rounded-full text-white hover:bg-white/40" title="Edit Lanjutan"><Wand2 className="w-5 h-5" /></button>
                        </div>
                        <div className="absolute top-2 left-2 bg-black/50 text-white text-[10px] px-2 py-1 rounded-full backdrop-blur-sm">Var {idx + 1}</div>
                    </div>
                ))}
            </div>

            {isModalOpen && (
                <div className="fixed inset-0 z-[60] bg-black/95 flex items-center justify-center p-4 backdrop-blur-md" onClick={() => setIsModalOpen(false)}>
                    
                    {/* Red Close Button */}
                    <button 
                        className="absolute top-4 right-4 p-2 z-50 rounded-full transition" 
                        onClick={(e) => { e.stopPropagation(); setIsModalOpen(false); }}
                        style={{ backgroundColor: colors.secondary, color: 'white' }} 
                    >
                        <X className="w-8 h-8" />
                    </button>
                    
                    {/* Previous Button (Slider) */}
                    {images.length > 1 && (
                        <button 
                            className="absolute left-4 text-white/80 hover:text-white p-4 transition" 
                            onClick={(e) => { e.stopPropagation(); setViewIndex(prev => prev === 0 ? images.length - 1 : prev - 1); }}
                        >
                            <ChevronLeft className="w-10 h-10" />
                        </button>
                    )}

                    <div 
                        className="max-w-3xl max-h-[85vh] relative group"
                        onClick={(e) => e.stopPropagation()}
                    >
                        <img src={images[viewIndex]} alt="Full View" className="max-h-[85vh] w-auto object-contain rounded-lg shadow-2xl aspect-square" />
                        <div className="absolute bottom-4 right-4 flex gap-3">
                            {/* Tombol Download & Edit di Modal */}
                             <button onClick={(e) => { e.stopPropagation(); handleDownload(images[viewIndex], viewIndex); }} className="bg-white/90 hover:bg-white text-gray-800 px-4 py-2 rounded-full font-bold shadow-lg flex items-center gap-2">
                                <Download className="w-4 h-4" /> Download
                            </button>
                            <button onClick={(e) => { e.stopPropagation(); setIsModalOpen(false); handleEdit(images[viewIndex], viewIndex); }} className="bg-white/90 hover:bg-white text-gray-800 px-4 py-2 rounded-full font-bold shadow-lg flex items-center gap-2">
                                <Wand2 className="w-4 h-4" /> Edit
                            </button>
                        </div>
                    </div>

                    {/* Next Button (Slider) */}
                    {images.length > 1 && (
                        <button 
                            className="absolute right-4 text-white/80 hover:text-white p-4 transition" 
                            onClick={(e) => { e.stopPropagation(); setViewIndex(prev => (prev + 1) % images.length); }}
                        >
                            <ChevronRight className="w-10 h-10" />
                        </button>
                    )}

                    {/* Index indicator */}
                    <div className="absolute bottom-8 flex gap-2">
                        {images.map((_, idx) => (
                            <div key={idx} className={`w-2 h-2 rounded-full transition-all ${idx === viewIndex ? 'bg-white w-6' : 'bg-white/40'}`} />
                        ))}
                    </div>
                </div>
            )}
        </div>
    );
};

// --- MODUL BARU: MAHAR DESIGN ---

const MaharDesignForm = ({ onGenerate, isGenerating, colors }) => {
    
    // --- PERUBAHAN DI SINI: Inisialisasi default dengan isAuto: true ---
    const initialConfig = useMemo(() => {
        const config = {};
        Object.keys(PRESET_OPTIONS.mahar).forEach(key => {
            config[key] = { value: '', isAuto: true }; // Default to Auto
        });
        return config;
    }, []);

    const [config, setConfig] = useState(initialConfig);
    // [START]: Perubahan State untuk Nama Pasangan
    const [nominalIsi, setNominalIsi] = useState('');
    const [namaPria, setNamaPria] = useState('');
    const [namaWanita, setNamaWanita] = useState('');
    const [weddingDate, setWeddingDate] = useState('');
    // [END]: Perubahan State untuk Nama Pasangan
    const [referenceFiles, setReferenceFiles] = useState([]);
    const [detailTambahan, setDetailTambahan] = useState('');

    const toggleAuto = (key) => {
        setConfig(prev => ({ ...prev, [key]: { ...prev[key], isAuto: !prev[key].isAuto } }));
    };

    const handleChange = (key, val) => {
        setConfig(prev => ({ ...prev, [key]: { ...prev[key], value: val } }));
    };

    const handleAutoFill = () => {
        const newConfig = { ...config };
        Object.keys(newConfig).forEach(key => newConfig[key].isAuto = true);
        setConfig(newConfig);
    };

    const fileToBase64 = (file) => new Promise((resolve, reject) => {
        if (!file) return resolve(null);
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = (error) => reject(error);
    });

    const handleSubmit = async (e) => {
        e.preventDefault();
        onGenerate({ start: true });

        try {
            const refImages = await Promise.all(referenceFiles.map(fileToBase64));

            // Format the date for the AI prompt
            const formattedDate = weddingDate 
                ? new Date(weddingDate).toLocaleDateString('en-US', { day: 'numeric', month: 'long', year: 'numeric' }) 
                : 'No date specified, use simple calligraphy date style';
            
            // [START FIX] Mengambil nama tanpa prefix untuk visual
            const namesPria = namaPria.trim() || 'Nama Pria';
            const namesWanita = namaWanita.trim() || 'Nama Wanita';
            // [END FIX]

            const promises = [1, 2].map(async (i) => {
                const imageParts = [];
                refImages.forEach(b64 => {
                    if (b64) imageParts.push({ inlineData: { mimeType: "image/jpeg", data: b64 } });
                });

                let prompt = `
                **HIGH FIDELITY PROFESSIONAL MAHAR (DOWRY) FRAME PHOTOGRAPHY - VARIATION ${i}**
                Create a photorealistic, studio-quality image of a Wedding Mahar Frame.
                
                **CONTENT:**
                - **Isi Mahar:** ${nominalIsi || 'Artistic arrangement of money/gold'}
                - **Nama Pengantin Pria (Visual Text):** ${namesPria}
                - **Nama Pengantin Wanita (Visual Text):** ${namesWanita}
                - **Wedding Date:** ${formattedDate}
                
                **INSTRUCTION VISUAL TEXT:** Render the names and date on the mahar. DO NOT include the descriptive prefixes (e.g., "Nama Pengantin Pria:") in the final visual image output. Use elegant calligraphy style, typically seen on Indonesian mahar.

                **DESIGN SPECS:**
                `;
                
                if (!config.FrameShape.isAuto) prompt += `- **Frame:** ${config.FrameShape.value}\n`;
                if (!config.ArrangementStyle.isAuto) prompt += `- **Style:** ${config.ArrangementStyle.value}\n`;
                if (!config.Culture.isAuto) prompt += `- **Culture/Adat:** ${config.Culture.value}\n`;
                if (!config.DecorationItems.isAuto) prompt += `- **Decoration:** ${config.DecorationItems.value}\n`;
                
                if (refImages.length > 0) prompt += `- **REFERENCE:** Use the uploaded image as a PRIMARY style reference.\n`;

                prompt += `
                - **Detail:** ${detailTambahan}
                
                **ENVIRONMENT (MANDATORY):**
                - **Background:** Professional studio setting with a SINGLE DRAPED FABRIC in ${!config.BackgroundFabric.isAuto ? config.BackgroundFabric.value : 'Elegant Soft Color'}.
                - **Lighting:** Softbox studio lighting, creating gentle shadows and highlights on the frame glass and textures.
                - **Composition:** Centered, 1:1 Aspect Ratio. Flat lay or slightly angled standing.
                
                **QUALITY:** 8k resolution, highly detailed textures (glass reflection, wood grain, paper texture, fabric folds).
                `;

                imageParts.unshift({ text: prompt });

                const apiKey = ""; 
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`;
                
                const response = await fetchWithRetry(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ role: "user", parts: imageParts }], generationConfig: { responseModalities: ['IMAGE'] } }) });
                
                // FIX: Menambahkan pengecekan base64 dan logging finishReason
                if (!response.ok) { console.error(`API response not OK for Mahar var ${i}.`); return null; }
                
                const result = await response.json();
                const base64 = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
                
                if (!base64) {
                    const finishReason = result?.candidates?.[0]?.finishReason;
                    const error = result?.error?.message || 'Unknown API failure.';
                    console.error(`Mahar gen failed for variation ${i}. Reason: ${finishReason || 'Missing Data'}. Error detail: ${error}. Response:`, result);
                }
                
                return base64 ? `data:image/png;base64,${base64}` : null;
            });

            const results = await Promise.all(promises);
            const validResults = results.filter(r => r !== null);
            if (validResults.length === 0) throw new Error("Gagal membuat gambar.");
            onGenerate({ data: { images: validResults }, start: false });
        } catch (error) {
            console.error(error);
            onGenerate({ start: false });
            // Menghapus alert()
        }
    };

    return (
        <form onSubmit={handleSubmit} className="flex flex-col gap-6 p-4 md:p-6">
            <h2 className="text-3xl font-bold text-center mb-4" style={{ color: colors.text }}>Mahar Design Studio</h2>
            
            <section className="space-y-4">
                 <div className="p-4 rounded-xl border-l-4 bg-white shadow-sm" style={{ borderColor: colors.primary }}>
                     <h4 className="font-semibold text-gray-700 mb-3 flex items-center gap-2"><Coins className="w-4 h-4"/> Detail Isi Mahar</h4>
                     <div className="space-y-3">
                        <div>
                            <label className="text-xs text-gray-500 mb-1 block">Nominal / Isi Mahar</label>
                            <input type="text" placeholder="Misal: Rp 1.000.000 tunai dan 10 gram emas" className="w-full p-2 border rounded-lg text-sm" value={nominalIsi} onChange={(e) => setNominalIsi(e.target.value)} />
                        </div>
                        {/* [START]: Perubahan Layout Input Nama Pasangan */}
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label className="text-xs text-gray-500 mb-1 block">Nama Pengantin Pria</label>
                                <input type="text" placeholder="Misal: Budi" className="w-full p-2 border rounded-lg text-sm" value={namaPria} onChange={(e) => setNamaPria(e.target.value)} />
                            </div>
                            <div>
                                <label className="text-xs text-gray-500 mb-1 block">Nama Pengantin Wanita</label>
                                <input type="text" placeholder="Misal: Ani" className="w-full p-2 border rounded-lg text-sm" value={namaWanita} onChange={(e) => setNamaWanita(e.target.value)} />
                            </div>
                        </div>
                        <div>
                             <label className="text-xs text-gray-500 mb-1 block">Tanggal Pernikahan</label>
                             <input type="date" className="w-full p-2 border rounded-lg text-sm" value={weddingDate} onChange={(e) => setWeddingDate(e.target.value)} />
                        </div>
                        {/* [END]: Perubahan Layout Input Nama Pasangan */}
                     </div>
                 </div>

                 {/* PERBAIKAN: Tombol AI Auto Fill dipindah kesini (setelah Detail Isi Mahar) */}
                 <div className="flex justify-end">
                    <button type="button" onClick={handleAutoFill} className="flex items-center gap-2 px-4 py-2 rounded-full text-white text-sm font-bold shadow-md hover:shadow-lg transition transform hover:scale-105" style={{ background: `linear-gradient(90deg, ${colors.accent} 0%, ${colors.supporting} 100%)` }}>
                        <Sparkles className="w-4 h-4" /> AI Auto Fill
                    </button>
                </div>

                 <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {['FrameShape', 'ArrangementStyle', 'Culture', 'DecorationItems', 'BackgroundFabric'].map(key => (
                        <InputGroup key={key} label={key.replace(/([A-Z])/g, ' $1').trim()} isAuto={config[key]?.isAuto || false} onToggleAuto={() => toggleAuto(key)}>
                            <Dropdown value={config[key]?.value || ''} onChange={(e) => handleChange(key, e.target.value)} options={PRESET_OPTIONS.mahar[key]} disabled={config[key]?.isAuto} />
                        </InputGroup>
                    ))}
                 </div>
            </section>

             <section className="p-5 rounded-xl bg-white shadow-md border-t-4" style={{ borderColor: colors.supporting }}>
                <h3 className="text-sm font-semibold mb-3 text-gray-700">Referensi & Detail</h3>
                <FileUpload label="Upload Referensi Desain (Opsional)" onFilesChange={setReferenceFiles} maxFiles={3} files={referenceFiles} />
                <div className="mt-3">
                    <OpenTextarea value={detailTambahan} onChange={(e) => setDetailTambahan(e.target.value)} placeholder="Detail tambahan (misal: nuansa warna sage green dominan...)" />
                </div>
            </section>

             <div className="w-full md:w-2/3 lg:w-1/2 mx-auto h-14 mt-4">
                 {isGenerating ? (
                    <div className="flex justify-center items-center h-full">
                         <svg className="animate-spin h-10 w-10" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke={colors.primary} strokeWidth="4" fill="none" className="opacity-25" /><path d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" fill={colors.secondary} /></svg>
                    </div>
                ) : (
                    <button type="submit" className={`w-full py-3 px-8 text-lg font-bold text-white rounded-full transition-all duration-300 shadow-xl h-full flex items-center justify-center gap-2 hover:scale-105`} style={{ background: `linear-gradient(90deg, ${colors.primary} 0%, ${colors.supporting} 100%)` }}>
                        Buat Desain Mahar
                    </button>
                )}
            </div>
        </form>
    );
};

const MaharDesignResults = ({ results, isLoading, colors, setEditContext }) => {
    // MODIFIKASI: Menggunakan style tombol hover MagicPhotoResults
    const images = results?.data?.images || [];
    const [viewIndex, setViewIndex] = useState(0);
    const [isModalOpen, setIsModalOpen] = useState(false);

    const handleDownload = (url, index) => {
        // PERBAIKAN DOWNLOAD: Gunakan safeDownload
        safeDownload(url, `Mahar-Var${index+1}-${Date.now()}.png`);
    };
    
    // Fungsi untuk membuka modal edit
    const handleEdit = (image, index) => {
        setEditContext({ image, index, layout: '1:1 (Square)' });
    };

    if (isLoading) return <div className="p-8 h-full flex flex-col justify-center"><SkeletonLoading primaryColor={colors.primary} secondaryColor={colors.secondary} bgColor={colors.bg} /></div>;
    
    if (images.length === 0) return (
        <div className="flex flex-col items-center justify-center h-full min-h-[500px] p-8 text-center" style={{ color: colors.text }}>
            <Gem className="w-20 h-20 mb-4 opacity-30" />
            <h3 className="text-xl font-semibold mb-2">Belum Ada Desain</h3>
            <p className="text-gray-500">Hasil desain mahar Anda akan muncul di sini.</p>
        </div>
    );

    return (
        <div className="p-6 h-full flex flex-col">
            <h2 className="text-2xl font-bold text-center mb-6" style={{ color: colors.text }}>Hasil Desain Mahar</h2>
            
            <div className="flex-1 grid grid-cols-1 md:grid-cols-2 gap-6 items-start">
                {images.map((img, idx) => (
                    // MODIFIKASI: Menambahkan aspect-square untuk tampilan gambar yang konsisten
                    <div key={idx} className="group relative aspect-square rounded-2xl overflow-hidden shadow-xl border-4 bg-white cursor-pointer transition duration-300" style={{ borderColor: idx === viewIndex ? colors.primary : 'transparent' }}>
                        <img src={img} alt={`Mahar ${idx+1}`} className="w-full h-full object-cover" />
                        {/* MODIFIKASI: Mengganti overlay dengan tombol Maximize, Download, dan Edit (Meniru Magic Photo) */}
                        <div className="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition flex items-center justify-center gap-3">
                            <button onClick={() => { setViewIndex(idx); setIsModalOpen(true); }} className="p-2 bg-white/20 backdrop-blur rounded-full text-white hover:bg-white/40" title="Lihat"><Maximize2 className="w-5 h-5" /></button>
                            <button onClick={() => handleDownload(img, idx)} className="p-2 bg-white/20 backdrop-blur rounded-full text-white hover:bg-white/40" title="Download"><Download className="w-5 h-5" /></button>
                             <button onClick={() => handleEdit(img, idx)} className="p-2 bg-white/20 backdrop-blur rounded-full text-white hover:bg-white/40" title="Edit Lanjutan"><Wand2 className="w-5 h-5" /></button>
                        </div>
                        <div className="absolute top-2 left-2 bg-black/50 text-white text-[10px] px-2 py-1 rounded-full backdrop-blur-sm">Var {idx + 1}</div>
                    </div>
                ))}
            </div>

            {isModalOpen && (
                <div className="fixed inset-0 z-[60] bg-black/95 flex items-center justify-center p-4 backdrop-blur-md" onClick={() => setIsModalOpen(false)}>
                    
                    {/* Red Close Button */}
                    <button 
                        className="absolute top-4 right-4 p-2 z-50 rounded-full transition" 
                        onClick={(e) => { e.stopPropagation(); setIsModalOpen(false); }}
                        style={{ backgroundColor: colors.secondary, color: 'white' }} 
                    >
                        <X className="w-8 h-8" />
                    </button>
                    
                    {/* Previous Button (Slider) */}
                    {images.length > 1 && (
                        <button 
                            className="absolute left-4 text-white/80 hover:text-white p-4 transition" 
                            onClick={(e) => { e.stopPropagation(); setViewIndex(prev => prev === 0 ? images.length - 1 : prev - 1); }}
                        >
                            <ChevronLeft className="w-10 h-10" />
                        </button>
                    )}

                    <div 
                        className="max-w-3xl max-h-[85vh] relative group"
                        onClick={(e) => e.stopPropagation()}
                    >
                        {/* MODIFIKASI: Menambahkan aspect-square agar modal tetap rapi */}
                        <img src={images[viewIndex]} alt="Full View" className="max-h-[85vh] w-auto object-contain rounded-lg shadow-2xl aspect-square" />
                        {/* Tombol Download & Edit di dalam modal (New Style) */}
                        <div className="absolute bottom-4 right-4 flex gap-3">
                             <button onClick={(e) => { e.stopPropagation(); handleDownload(images[viewIndex], viewIndex); }} className="bg-white/90 hover:bg-white text-gray-800 px-4 py-2 rounded-full font-bold shadow-lg flex items-center gap-2">
                                <Download className="w-4 h-4" /> Download
                            </button>
                             <button onClick={(e) => { e.stopPropagation(); setIsModalOpen(false); handleEdit(images[viewIndex], viewIndex); }} className="bg-white/90 hover:bg-white text-gray-800 px-4 py-2 rounded-full font-bold shadow-lg flex items-center gap-2">
                                <Wand2 className="w-4 h-4" /> Edit
                            </button>
                        </div>
                    </div>

                    {/* Next Button (Slider) */}
                    {images.length > 1 && (
                        <button 
                            className="absolute right-4 text-white/80 hover:text-white p-4 transition" 
                            onClick={(e) => { e.stopPropagation(); setViewIndex(prev => (prev + 1) % images.length); }}
                        >
                            <ChevronRight className="w-10 h-10" />
                        </button>
                    )}

                    {/* Index indicator */}
                    <div className="absolute bottom-8 flex gap-2">
                        {images.map((_, idx) => (
                            <div key={idx} className={`w-2 h-2 rounded-full transition-all ${idx === viewIndex ? 'bg-white w-6' : 'bg-white/40'}`} />
                        ))}
                    </div>
                </div>
            )}
        </div>
    );
};

// --- MODUL BARU: MAGIC PHOTO ---

const MagicPhotoForm = ({ onGenerate, isGenerating, colors }) => {
    // 1. Core Items (No Auto)
    const [magicItem, setMagicItem] = useState([]);
    const [itemType, setItemType] = useState('Hantaran');
    const [isDetecting, setIsDetecting] = useState(false);
    const [style, setStyle] = useState('Tanpa Model');
    const [removeBg, setRemoveBg] = useState('Pertahankan Background');
    const [detail, setDetail] = useState('');

    // 2. Configurable Items (With Auto)
    const [config, setConfig] = useState({
        PoseTangan: { value: '', isAuto: false },
        PoseModel: { value: '', isAuto: false },
        UploadModel: { value: [], isAuto: false }, // Use auto as 'Random Model'
        Environment: { value: '', isAuto: false },
        Background: { value: '', isAuto: false },
        Mood: { value: '', isAuto: false },
        // CameraAngle removed as requested
        ImageLayout: { value: '1:1 (Square)', isAuto: false },
        ItemPosition: { value: 'Berdiri Tegak (Standing Upright)', isAuto: false }, 
    });

    // Auto Detection Effect
    useEffect(() => {
        const detectItemType = async () => {
            if (magicItem.length === 0) return;
            setIsDetecting(true);
            try {
                const b64 = await fileToBase64(magicItem[0]);
                const apiKey = ""; 
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview:generateContent?key=${apiKey}`;
                
                // Prompt ringan untuk klasifikasi
                const prompt = `
                Lihat gambar ini. Klasifikasikan objek utama HANYA menjadi salah satu dari 3 kategori ini:
                1. "Hantaran" (Box seserahan, kotak cincin, nampan hadiah)
                2. "Buket Bunga" (Rangkaian bunga tangan)
                3. "Mahar" (Pigura uang, bingkai logam mulia)
                
                Jika tidak yakin, pilih yang paling mendekati.
                Jawab HANYA dengan satu kata kategori tersebut.
                `;

                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            role: "user",
                            parts: [
                                { text: prompt },
                                { inlineData: { mimeType: "image/jpeg", data: b64 } }
                            ]
                        }]
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    const text = result?.candidates?.[0]?.content?.parts?.[0]?.text?.trim();
                    if (text && ['Hantaran', 'Buket Bunga', 'Mahar'].includes(text)) {
                        setItemType(text);
                    }
                }
            } catch (e) {
                console.error("Auto detect failed", e);
            } finally {
                setIsDetecting(false);
            }
        };

        detectItemType();
    }, [magicItem]);

    const toggleAuto = (key) => {
        setConfig(prev => ({ ...prev, [key]: { ...prev[key], isAuto: !prev[key].isAuto } }));
    };

    const handleChange = (key, val) => {
        setConfig(prev => ({ ...prev, [key]: { ...prev[key], value: val } }));
    };

    const handleFileChange = (key, files) => {
        setConfig(prev => ({ ...prev, [key]: { ...prev[key], value: files } }));
    };

    const handleAutoFill = () => {
        const newConfig = { ...config };
        Object.keys(newConfig).forEach(key => {
             newConfig[key].isAuto = true;
        });
        setConfig(newConfig);
    };

    const fileToBase64 = (file) => new Promise((resolve, reject) => {
        if (!file) return resolve(null);
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = (error) => reject(error);
    });
    
    const handleSubmit = async (e) => {
        e.preventDefault();
        
        if (magicItem.length === 0) {
            console.error("Harap upload 1 foto produk utama!");
            return;
        }

        onGenerate({ start: true });

        try {
            const itemBase64 = await fileToBase64(magicItem[0]);
            let modelBase64 = null;
            if (style === 'Dengan Model' && !config.UploadModel.isAuto && config.UploadModel.value.length > 0) {
                 modelBase64 = await fileToBase64(config.UploadModel.value[0]);
            }

            // LOOP MENJADI 2 UNTUK KUALITAS LEBIH TINGGI
            const promises = [1, 2].map(async (i) => {
                const imageParts = [];
                if (itemBase64) imageParts.push({ inlineData: { mimeType: "image/jpeg", data: itemBase64 } });
                if (modelBase64) imageParts.push({ inlineData: { mimeType: "image/jpeg", data: modelBase64 } });

                // --- DEEP ANALYSIS PROMPT STRUCTURE ---
                const promptParts = [];
                promptParts.push(`**SYSTEM INSTRUCTION: DEEP VISUAL REASONING & GENERATION**`);
                promptParts.push(`You are a world-class Product Photographer and CGI Artist. Before generating the image, perform a deep analysis.`);
                
                // --- CRITICAL OBJECT IDENTITY PROTECTION ---
                promptParts.push(`**CRITICAL: OBJECT FIDELITY**`);
                promptParts.push(`- The visual identity of the "Object" MUST remain 100% IDENTICAL to the reference image. NO HALLUCINATIONS.`);
                promptParts.push(`- PRESERVE: Shape, Logos, Textures, Colors, and Proportions EXACTLY.`);
                promptParts.push(`- Do NOT morph, distort, or reimagine the object's features. Only change lighting and environment.`);

                // STEP 1: ANALYSIS
                promptParts.push(`**STEP 1: VISUAL ANALYSIS (INTERNAL)**`);
                promptParts.push(`- Analyze the input "Object" (${itemType}). Identify material (velvet, glass, flowers), lighting direction, and perspective.`);
                
                // STEP 2: SCENE PLANNING
                promptParts.push(`**STEP 2: SCENE PLANNING**`);
                
                // --- LOGIC BRANCHING BASED ON STYLE & BACKGROUND ---
                if (style === 'Tanpa Model') {
                    if (removeBg === 'Pertahankan Background') {
                        // SCENARIO A: RETOUCH ONLY
                        promptParts.push(`- **MODE:** CREATIVE ENHANCEMENT (KEEP BACKGROUND).`);
                        promptParts.push(`- **CRITICAL:** DO NOT REMOVE THE BACKGROUND. The original environment must remain.`);
                        promptParts.push(`- **ACTION:** Enhance lighting/color. Simulate the requested camera angle by warping perspective if needed, but keep the scene consistent.`);
                    } else {
                        // SCENARIO B: COMPOSITE TO NEW ENVIRONMENT
                        const env = config.Environment.isAuto ? ["Luxury Podium", "Sunlit Window", "Garden Table", "Minimalist Studio"][i%4] : config.Environment.value;
                        const bgDet = config.Background.isAuto ? "matching aesthetic props" : config.Background.value;
                        
                        promptParts.push(`- **MODE:** FULL COMPOSITE (NEW BACKGROUND).`);
                        promptParts.push(`- **CRITICAL:** COMPLETELY REMOVE the old background.`);
                        promptParts.push(`- **NEW SCENE:** Place the ${itemType} in a "${env}".`);
                        promptParts.push(`- **DETAILS:** Add "${bgDet}" to the scene for realism.`);
                        
                        // NEW LOGIC: ITEM POSITION
                        if (['Buket Bunga', 'Mahar'].includes(itemType)) {
                             const pos = config.ItemPosition.value;
                             promptParts.push(`- **PHYSICS & GRAVITY:** The item is **${pos}**. Ensure contact shadows and weight distribution reflect this position.`);
                        } else {
                             promptParts.push(`- **PHYSICS:** Place the object naturally on the surface.`);
                        }
                    }
                } else if (style === 'Hand Carry') {
                    // SCENARIO C: HAND CARRY (POV)
                    const env = config.Environment.isAuto ? "blurred natural bokeh" : config.Environment.value;
                    const pose = config.PoseTangan.isAuto ? "holding it gently and elegantly" : config.PoseTangan.value;
                    promptParts.push(`- **MODE:** HAND MODEL GENERATION.`);
                    promptParts.push(`- **ACTION:** Generate a realistic hand holding the ${itemType}. Pose: ${pose}.`);
                    promptParts.push(`- **BACKGROUND:** "${env}".`);
                } else if (style === 'Dengan Model') {
                    // SCENARIO D: FULL MODEL
                    const env = config.Environment.isAuto ? "lifestyle indoor setting" : config.Environment.value;
                    const pose = config.PoseModel.isAuto ? "interacting naturally with the product" : config.PoseModel.value;
                    promptParts.push(`- **MODE:** LIFESTYLE MODEL PHOTOGRAPHY.`);
                    promptParts.push(`- **ACTION:** Generate a model ${pose} with the ${itemType}. Background: "${env}".`);
                    
                    if (modelBase64) {
                        promptParts.push(`- **IDENTITY:** STRICTLY MATCH the face of the second uploaded image.`);
                    } else {
                        promptParts.push(`- **MODEL LOOK:** Indonesian professional model.`);
                    }
                }

                // --- STEP 3: EXECUTION DETAILS ---
                promptParts.push(`**STEP 3: EXECUTION PARAMETERS**`);
                
                // Mood
                const mood = config.Mood.isAuto ? "High-End & Luxurious" : config.Mood.value;
                promptParts.push(`- **MOOD:** ${mood}.`);

                // Automatic Camera Angle Guidance (Since User Control is Removed)
                promptParts.push(`- **CAMERA ANGLE:** Choose the most aesthetic, professional angle for this specific object (e.g., slightly High Angle for trays, Eye Level for bouquets).`);

                // Composition & Safe Zones for Cropping (REVISED LOGIC HERE)
                const selectedLayout = config.ImageLayout.value;
                let layoutIntent = "Center composition. Ensure the entire product/subject is clearly visible and placed within the frame, with adequate negative space around it. The image output must be square (1:1).";
                
                if (selectedLayout.includes('9:16')) {
                    // Target is tall (9/16 = 0.5625 ratio)
                    layoutIntent = "Vertical Portrait (9:16) Intention. The composition MUST prioritize the visibility of the whole product, ensuring it is contained within the central 9:16 vertical area of the square output. Add generous horizontal negative space/background to the left and right to avoid cropping.";
                } else if (selectedLayout.includes('4:3')) {
                    // Target is wide (4/3 = 1.33 ratio)
                    layoutIntent = "Horizontal Landscape (4:3) Intention. The composition MUST prioritize the visibility of the whole product, ensuring it is contained within the central 4:3 horizontal area of the square output. Add generous vertical negative space/background above and below to avoid cropping.";
                } else if (selectedLayout.includes('3:4')) {
                    // Target is tall (3/4 = 0.75 ratio)
                    layoutIntent = "Vertical Portrait (3:4) Intention. The composition MUST prioritize the visibility of the whole product, ensuring it is contained within the central 3:4 vertical area of the square output. Add horizontal negative space/background to the left and right to avoid cropping.";
                }
                
                promptParts.push(`- **COMPOSITION:** ${layoutIntent}`);

                // --- USER MANDATORY OVERRIDE ---
                if (detail) {
                    promptParts.push(`**USER MANDATORY OVERRIDE:** "${detail}" (You MUST include this element no matter what).`);
                }

                promptParts.push(`**NEGATIVE PROMPT:** distorted hands, extra fingers, floating object, bad photoshop, cartoon, illustration, low resolution, blurry, ugly face, distorted face, different person.`);

                imageParts.unshift({ text: promptParts.join('\n') });

                const apiKey = ""; 
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`;
                
                try {
                    const response = await fetchWithRetry(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ role: "user", parts: imageParts }], generationConfig: { responseModalities: ['IMAGE'] } }) });
                    if (!response.ok) return null;
                    const result = await response.json();
                    const base64 = result?.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;

                    // FIX: Menambahkan pengecekan base64 dan logging finishReason
                    if (!base64) {
                        const finishReason = result?.candidates?.[0]?.finishReason;
                        const error = result?.error?.message || 'Unknown API failure.';
                        console.error(`Magic Photo gen failed for variation ${i}. Reason: ${finishReason || 'Missing Data'}. Error detail: ${error}. Response:`, result);
                    }
                    
                    return {
                        image: base64 ? `data:image/png;base64,${base64}` : null,
                        layout: config.ImageLayout.value // Pass layout for rendering
                    };
                } catch (e) { return null; }
            });

            const results = await Promise.all(promises);
            const validResults = results.filter(res => res && res.image !== null);
            
            if (validResults.length === 0) throw new Error("Gagal membuat gambar.");
            onGenerate({ data: { results: validResults }, start: false });

        } catch (error) {
            console.error(error);
            onGenerate({ start: false });
            // Menghapus alert()
        }
    };

    // Filter Background Options based on Environment
    const getBackgroundOptions = () => {
        if (!config.Environment.value || config.Environment.isAuto) return [];
        return PRESET_OPTIONS.magic.Backgrounds[config.Environment.value] || [];
    };

    // --- LOGIC UI DISABLE (UPDATED) ---
    // Jika Style = Tanpa Model DAN RemoveBg = Pertahankan, HANYA Env & Bg Detail yang mati.
    const isRetouchMode = (style === 'Tanpa Model' && removeBg === 'Pertahankan Background');
    
    // Logic untuk menampilkan preset Posisi Item
    const showItemPosition = ['Buket Bunga', 'Mahar'].includes(itemType) && style === 'Tanpa Model' && removeBg === 'Hilangkan Background';

    return (
        <form onSubmit={handleSubmit} className="flex flex-col gap-6 p-4 md:p-6">
            <div className="flex justify-between items-center mb-4">
                 {/* PERBAIKAN: Header Center Align */}
                 <h2 className="text-3xl font-bold w-full text-center" style={{ color: colors.text }}>Magic Photo Studio</h2>
            </div>

            {/* 1. Upload & Item Type */}
            <section className="p-5 rounded-xl bg-white shadow-md border-t-4" style={{ borderColor: colors.secondary }}>
                <h3 className="text-xl font-semibold mb-4 flex items-center gap-2" style={{ color: colors.text }}><Camera className="w-5 h-5" /> 1. Upload Barang</h3>
                <FileUpload label="Upload 1 foto produk utama" onFilesChange={setMagicItem} maxFiles={1} files={magicItem} />
                <div className="mt-4">
                    <div className="flex justify-between items-center mb-2">
                        <label className="text-sm font-semibold text-gray-700">Jenis Item (Auto-Detect)</label>
                        {isDetecting && <span className="text-xs text-blue-500 animate-pulse flex items-center gap-1"><Sparkles className="w-3 h-3"/> Mendeteksi...</span>}
                    </div>
                    <div className="flex gap-2">
                        {['Hantaran', 'Buket Bunga', 'Mahar'].map(item => (
                            <button type="button" key={item} onClick={() => setItemType(item)} className="flex-1 py-2 rounded-lg text-sm font-bold border transition relative overflow-hidden" style={{ backgroundColor: itemType === item ? colors.primary : 'white', color: itemType === item ? 'white' : colors.text }}>
                                {item}
                                {itemType === item && <div className="absolute inset-0 bg-white/20 animate-pulse" />}
                            </button>
                        ))}
                    </div>
                </div>
            </section>

             {/* PERBAIKAN: Tombol AI Auto Fill dipindah kesini (setelah upload barang) */}
             <div className="flex justify-end">
                <button type="button" onClick={handleAutoFill} className="flex items-center gap-2 px-4 py-2 rounded-full text-white text-sm font-bold shadow-md hover:shadow-lg transition transform hover:scale-105" style={{ background: `linear-gradient(90deg, ${colors.accent} 0%, ${colors.supporting} 100%)` }}>
                    <Sparkles className="w-4 h-4" /> AI Auto Fill
                </button>
            </div>

            {/* 2. Style & Context */}
            <section className="p-5 rounded-xl bg-white shadow-md border-t-4" style={{ borderColor: colors.supporting }}>
                <h3 className="text-xl font-semibold mb-4 flex items-center gap-2" style={{ color: colors.text }}><User className="w-5 h-5" /> 2. Gaya Foto</h3>
                
                {/* Style Selector */}
                <div className="flex gap-2 mb-6">
                     {[{ label: 'Tanpa Model', icon: Box }, { label: 'Hand Carry', icon: Hand }, { label: 'Dengan Model', icon: User }].map(opt => (
                        <button type="button" key={opt.label} onClick={() => setStyle(opt.label)} className="flex-1 flex items-center justify-center gap-2 py-3 rounded-lg text-sm font-bold border transition" style={{ backgroundColor: style === opt.label ? colors.secondary : 'white', color: style === opt.label ? 'white' : colors.text }}>
                            <opt.icon className="w-4 h-4" /> {opt.label}
                        </button>
                    ))}
                </div>

                {/* Conditional Inputs based on Style */}
                <div className="space-y-4 bg-gray-50 p-4 rounded-xl border">
                    {style === 'Tanpa Model' && (
                         <div className="flex flex-col gap-2">
                            <label className="text-sm font-semibold text-gray-700">Remove Background</label>
                            <div className="flex gap-2">
                                {['Pertahankan Background', 'Hilangkan Background'].map(opt => (
                                    <button type="button" key={opt} onClick={() => setRemoveBg(opt)} className="flex-1 py-2 text-xs font-bold rounded-lg border transition" style={{ backgroundColor: removeBg === opt ? colors.text : 'white', color: removeBg === opt ? 'white' : colors.text }}>{opt}</button>
                                ))}
                            </div>
                         </div>
                    )}

                    {style === 'Hand Carry' && (
                        <InputGroup label="Pose Tangan" isAuto={config.PoseTangan.isAuto} onToggleAuto={() => toggleAuto('PoseTangan')}>
                             <Dropdown value={config.PoseTangan.value || ''} onChange={(e) => handleChange('PoseTangan', e.target.value)} options={PRESET_OPTIONS.magic.PosesHandCarry} disabled={config.PoseTangan.isAuto} />
                        </InputGroup>
                    )}

                    {style === 'Dengan Model' && (
                        <>
                            <InputGroup label="Foto Model" isAuto={config.UploadModel.isAuto} onToggleAuto={() => toggleAuto('UploadModel')}>
                                {config.UploadModel.isAuto ? (
                                    <div className="p-3 bg-blue-50 text-blue-700 text-sm rounded-lg text-center font-semibold">Menggunakan Model Random AI</div>
                                ) : (
                                    <FileUpload label="Upload foto model (Opsional)" onFilesChange={(f) => handleFileChange('UploadModel', f)} maxFiles={1} files={config.UploadModel.value} />
                                )}
                            </InputGroup>
                            <InputGroup label="Pose Model" isAuto={config.PoseModel.isAuto} onToggleAuto={() => toggleAuto('PoseModel')}>
                                <Dropdown value={config.PoseModel.value || ''} onChange={(e) => handleChange('PoseModel', e.target.value)} options={PRESET_OPTIONS.magic.PosesModel} disabled={config.PoseModel.isAuto} />
                            </InputGroup>
                        </>
                    )}

                    {/* NEW: ITEM POSITION PRESET UI UPDATE */}
                    {showItemPosition && (
                         <InputGroup label="Posisi Item (Gravity)" isAuto={false}>
                            <div className="grid grid-cols-3 gap-2">
                                {PRESET_OPTIONS.magic.ItemPosition.map(pos => (
                                     <button 
                                        type="button" 
                                        key={pos} 
                                        onClick={() => handleChange('ItemPosition', pos)} 
                                        className={`py-2 px-3 text-[10px] md:text-xs font-bold rounded-lg transition-all duration-200 shadow-sm
                                            ${config.ItemPosition.value === pos 
                                                ? `bg-[${colors.primary}] text-white shadow-md transform scale-[1.02]` 
                                                : 'bg-white text-gray-600 hover:bg-gray-50 border border-gray-100'}`}
                                        style={{ 
                                            backgroundColor: config.ItemPosition.value === pos ? colors.primary : 'white',
                                            color: config.ItemPosition.value === pos ? 'white' : colors.text
                                        }}
                                     >
                                         {/* Split Indonesian and English text for better layout */}
                                         {pos.split('(')[0].trim()} 
                                         <span className="block text-[9px] font-normal opacity-80 mt-1">
                                            {pos.split('(')[1]?.replace(')', '')}
                                         </span>
                                     </button>
                                 ))}
                            </div>
                         </InputGroup>
                    )}
                </div>
            </section>

            {/* 3. Visual Environment (Dependency Chain) */}
            <section className={`p-5 rounded-xl bg-white shadow-md border-t-4 transition-all duration-300`} style={{ borderColor: colors.primary }}>
                 <div className="flex justify-between items-center mb-4">
                    <h3 className="text-xl font-semibold flex items-center gap-2" style={{ color: colors.text }}><Palette className="w-5 h-5" /> 3. Detail Visual & Lingkungan</h3>
                 </div>
                 
                 <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {/* Environment - Disabled ONLY if Retouch Mode */}
                    <InputGroup label="Environment" isAuto={config.Environment.isAuto} onToggleAuto={() => toggleAuto('Environment')} disabled={isRetouchMode}>
                        <Dropdown value={config.Environment.value || ''} onChange={(e) => handleChange('Environment', e.target.value)} options={PRESET_OPTIONS.magic.Environment} disabled={config.Environment.isAuto || isRetouchMode} placeholder={isRetouchMode ? "Terkunci (Mode Retouch)" : "Pilih salah satu..."} />
                    </InputGroup>

                    {/* Background (Dependent on Environment) - Disabled ONLY if Retouch Mode */}
                    <InputGroup label="Background Detail" isAuto={config.Background.isAuto} onToggleAuto={() => toggleAuto('Background')} disabled={isRetouchMode}>
                        <Dropdown 
                            value={config.Background.value || ''} 
                            onChange={(e) => handleChange('Background', e.target.value)} 
                            options={getBackgroundOptions()} 
                            disabled={config.Background.isAuto || !config.Environment.value || isRetouchMode} 
                            placeholder={isRetouchMode ? "Terkunci (Mode Retouch)" : (!config.Environment.value ? "Pilih Environment dulu..." : "Pilih Detail Background...")}
                        />
                    </InputGroup>

                    {/* Mood - ALWAYS ACTIVE */}
                    <InputGroup label="Mood" isAuto={config.Mood.isAuto} onToggleAuto={() => toggleAuto('Mood')}>
                        <Dropdown value={config.Mood.value || ''} onChange={(e) => handleChange('Mood', e.target.value)} options={PRESET_OPTIONS.magic.Mood} disabled={config.Mood.isAuto} />
                    </InputGroup>

                    {/* Image Layout - ALWAYS ACTIVE */}
                    <InputGroup label="Image Layout" isAuto={config.ImageLayout.isAuto} onToggleAuto={() => toggleAuto('ImageLayout')}>
                        <div className="grid grid-cols-2 gap-2">
                             {PRESET_OPTIONS.magic.LayoutImage.map(layout => (
                                 <button type="button" key={layout} onClick={() => handleChange('ImageLayout', layout)} disabled={config.ImageLayout.isAuto} className={`py-2 text-[10px] font-bold rounded border transition ${config.ImageLayout.value === layout && !config.ImageLayout.isAuto ? 'bg-gray-800 text-white' : 'bg-white text-gray-700'}`}>
                                     {layout}
                                 </button>
                             ))}
                        </div>
                    </InputGroup>
                 </div>

                 <div className="mt-4">
                     <InputGroup label="Detail Tambahan (Wajib Dipatuhi AI)" isAuto={false}>
                        <OpenTextarea value={detail} onChange={(e) => setDetail(e.target.value)} placeholder="Contoh: Tambahkan efek asap tipis, pastikan logo terlihat..." />
                     </InputGroup>
                 </div>
            </section>

            <div className="w-full md:w-2/3 lg:w-1/2 mx-auto h-14">
                {isGenerating ? (
                    <div className="flex justify-center items-center h-full rounded-full gap-3">
                         <svg className="animate-spin h-10 w-10" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke={colors.primary} strokeWidth="4" fill="none" className="opacity-25" /><path d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" fill={colors.secondary} /></svg>
                         <span className="text-gray-500 font-bold animate-pulse">Menganalisa & Mengolah...</span>
                    </div>
                ) : (
                    <button type="submit" disabled={magicItem.length === 0} className={`w-full py-3 px-8 text-lg font-bold text-white rounded-full transition-all duration-300 shadow-xl h-full flex items-center justify-center gap-2 ${magicItem.length === 0 ? 'opacity-60 cursor-not-allowed' : 'hover:scale-[1.02] hover:shadow-2xl'}`} style={{ background: `linear-gradient(90deg, ${colors.secondary} 0%, ${colors.primary} 100%)` }}>
                        Generate Magic Photos
                    </button>
                )}
            </div>
        </form>
    );
};

const MagicPhotoResults = ({ results, isLoading, colors, setEditContext }) => {
    // Correctly handle the new data structure from handleSubmit
    const dataList = results?.data?.results || [];
    // State baru untuk modal view
    const [viewIndex, setViewIndex] = useState(0); 
    const [isModalOpen, setIsModalOpen] = useState(false);

    // Dapatkan item yang sedang dilihat
    const currentItem = dataList[viewIndex];
    
    // Fungsi baru untuk download cropped
    const handleDownloadCropped = (item, index) => {
        const img = new Image();
        img.src = item.image;
        img.crossOrigin = "anonymous";
        img.onload = () => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Tentukan rasio
            let width = img.width;
            let height = img.height;
            let ratio = 1;

            if (item.layout.includes('9:16')) ratio = 9/16;
            if (item.layout.includes('4:3')) ratio = 4/3;
            if (item.layout.includes('3:4')) ratio = 3/4;
            
            // Hitung crop
            let newWidth, newHeight;
            if (item.layout.includes('1:1')) {
                newWidth = width; newHeight = height; 
            } else {
                // If aiming for 9:16 (tall), width is limiting factor usually if source is square
                if (width / height > ratio) {
                    // Source wider than target
                    newHeight = height;
                    newWidth = height * ratio;
                } else {
                    // Source taller than target
                    newWidth = width;
                    newHeight = width / ratio;
                }
            }

            canvas.width = newWidth;
            canvas.height = newHeight;
            
            // Center crop draw logic
            const startX = (width - newWidth) / 2;
            const startY = (height - newHeight) / 2;
            
            ctx.drawImage(img, startX, startY, newWidth, newHeight, 0, 0, newWidth, newHeight);
            
            // PERBAIKAN DOWNLOAD: Gunakan safeDownload
            safeDownload(canvas.toDataURL('image/png'), `Magic-Photo-${index + 1}-${Date.now()}.png`);
        };
    };
    
    // Fungsi untuk membuka modal edit
    const handleEdit = (item, index) => {
        setEditContext({ image: item.image, index, layout: item.layout });
    };

    // Helper to determine tailwind aspect ratio class based on the layout string
    const getAspectRatioClass = (layoutString) => {
        if (!layoutString) return "aspect-square";
        if (layoutString.includes('9:16')) return "aspect-[9/16]";
        if (layoutString.includes('4:3')) return "aspect-[4/3]";
        if (layoutString.includes('3:4')) return "aspect-[3/4]";
        return "aspect-square";
    };

    // Navigation functions
    const goToPrev = (e) => {
        e.stopPropagation();
        setViewIndex(prev => (prev - 1 + dataList.length) % dataList.length);
    };
    const goToNext = (e) => {
        e.stopPropagation();
        setViewIndex(prev => (prev + 1) % dataList.length);
    };


    if (isLoading) return <div className="p-6"><h2 className="text-2xl font-bold text-center mb-6" style={{ color: colors.text }}>Sedang Memproses 2 Variasi Premium...</h2><SkeletonGrid primaryColor={colors.primary} secondaryColor={colors.secondary} /></div>;
    
    if (dataList.length === 0) return <div className="flex flex-col items-center justify-center h-full min-h-[400px] p-8 text-center" style={{ color: colors.text }}><Camera className="w-16 h-16 mb-4 opacity-50" /><h3 className="text-xl font-semibold mb-2">Belum Ada Foto</h3><p className="text-gray-500">Hasil sulap foto Anda akan muncul di sini.</p></div>;

    return (
        <div className="p-6 flex flex-col gap-6">
            <h2 className="text-3xl font-bold text-center" style={{ color: colors.text }}>Hasil Magic Photo</h2>
            {/* FIXED 2x2 GRID */}
            <div className="grid grid-cols-2 gap-4">
                {dataList.map((item, idx) => (
                    <div key={idx} className={`group relative rounded-xl overflow-hidden shadow-lg bg-gray-100 border-2 border-transparent hover:border-[${colors.primary}] transition ${getAspectRatioClass(item.layout)}`}>
                        <img src={item.image} alt={`Result ${idx}`} className="w-full h-full object-cover" />
                        <div className="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition flex items-center justify-center gap-3">
                            {/* Memperbarui handler untuk modal view */}
                            <button onClick={() => { setViewIndex(idx); setIsModalOpen(true); }} className="p-2 bg-white/20 backdrop-blur rounded-full text-white hover:bg-white/40" title="Lihat"><Maximize2 className="w-5 h-5" /></button>
                            <button onClick={() => handleDownloadCropped(item, idx)} className="p-2 bg-white/20 backdrop-blur rounded-full text-white hover:bg-white/40" title="Download"><Download className="w-5 h-5" /></button>
                            <button onClick={() => handleEdit(item, idx)} className="p-2 bg-white/20 backdrop-blur rounded-full text-white hover:bg-white/40" title="Edit Lanjutan"><Wand2 className="w-5 h-5" /></button>
                        </div>
                        <div className="absolute top-2 left-2 bg-black/50 text-white text-[10px] px-2 py-1 rounded-full backdrop-blur-sm">Var {idx + 1}</div>
                    </div>
                ))}
            </div>
            
            {/* MODAL VIEW - FIXED TO RESPECT ASPECT RATIO (MODIFIKASI BARU) */}
            {isModalOpen && currentItem && (
                <div className="fixed inset-0 z-[60] bg-black/95 flex items-center justify-center p-4 backdrop-blur-sm" onClick={() => setIsModalOpen(false)}>
                    
                    {/* Tombol Close Merah */}
                    <button 
                        className="absolute top-4 right-4 p-2 z-50 rounded-full transition" 
                        onClick={(e) => { e.stopPropagation(); setIsModalOpen(false); }}
                        style={{ backgroundColor: colors.secondary, color: 'white' }} 
                    >
                        <X className="w-8 h-8" />
                    </button>
                    
                    {/* Tombol Sebelumnya (Slider) */}
                    {dataList.length > 1 && (
                        <button 
                            className="absolute left-4 text-white/80 hover:text-white p-4 transition" 
                            onClick={goToPrev}
                        >
                            <ChevronLeft className="w-10 h-10" />
                        </button>
                    )}

                    <div 
                        className="relative w-full h-full max-h-[90vh] max-w-[90vw] flex items-center justify-center p-4"
                        onClick={(e) => e.stopPropagation()}
                    >
                        <div className={`shadow-2xl rounded-xl overflow-hidden max-w-full max-h-full ${getAspectRatioClass(currentItem.layout)}`} style={{ width: 'auto', height: 'auto', maxWidth: '100%', maxHeight: '100%' }}>
                             <img 
                                src={currentItem.image} 
                                alt="Full View" 
                                className="w-full h-full object-cover" 
                                style={{ objectFit: 'cover' }} 
                             />
                        </div>
                         {/* Tombol Download & Edit di Modal */}
                        <div className="absolute bottom-4 right-4 flex gap-3">
                            <button onClick={(e) => { e.stopPropagation(); handleDownloadCropped(currentItem, viewIndex); }} className="bg-white/90 hover:bg-white text-gray-800 px-4 py-2 rounded-full font-bold shadow-lg flex items-center gap-2">
                                <Download className="w-4 h-4" /> Download
                            </button>
                            <button onClick={(e) => { e.stopPropagation(); setIsModalOpen(false); handleEdit(currentItem, viewIndex); }} className="bg-white/90 hover:bg-white text-gray-800 px-4 py-2 rounded-full font-bold shadow-lg flex items-center gap-2">
                                <Wand2 className="w-4 h-4" /> Edit
                            </button>
                        </div>
                    </div>

                    {/* Tombol Selanjutnya (Slider) */}
                    {dataList.length > 1 && (
                        <button 
                            className="absolute right-4 text-white/80 hover:text-white p-4 transition" 
                            onClick={goToNext}
                        >
                            <ChevronRight className="w-10 h-10" />
                        </button>
                    )}
                    
                    {/* Index indicator */}
                    <div className="absolute bottom-8 flex gap-2">
                        {dataList.map((_, idx) => (
                            <div key={idx} className={`w-2 h-2 rounded-full transition-all ${idx === viewIndex ? 'bg-white w-6' : 'bg-white/40'}`} />
                        ))}
                    </div>
                </div>
            )}
        </div>
    );
};

// --- MODUL UTAMA: ARRANGEMENT IDEA ---

const ArrangementIdeaForm = ({ onGenerate, isGenerating, colors }) => {
  const [hantaranItems, setHantaranItems] = useState([]);
  const [decoration, setDecoration] = useState({});
  const [photoStyle, setPhotoStyle] = useState({});
  const [otherDetail, setOtherDetail] = useState('');
  const [containerRef, setContainerRef] = useState(null);
  const [decorElementRef, setDecorElementRef] = useState([]);
  const [errors, setErrors] = useState({});

  const handleToggleAuto = (section, key) => {
    const setState = section === 'decoration' ? setDecoration : setPhotoStyle;
    setState(prev => ({ ...prev, [key]: { ...prev[key], isAuto: !prev[key]?.isAuto, value: !prev[key]?.isAuto ? '' : prev[key]?.value } }));
  };

  const handleChange = (section, key, value) => {
    const setState = section === 'decoration' ? setDecoration : setPhotoStyle;
    setState(prev => ({ ...prev, [key]: { value: value, isAuto: false } }));
  };

  const handleSerahkanPadaAI = () => {
    const newDecoration = {}, newPhotoStyle = {};
    Object.keys(PRESET_OPTIONS.decoration).forEach(key => { newDecoration[key] = { isAuto: true, value: '' }; });
    Object.keys(PRESET_OPTIONS.photoStyle).forEach(key => { newPhotoStyle[key] = { isAuto: true, value: '' }; });
    setDecoration(newDecoration); setPhotoStyle(newPhotoStyle); setOtherDetail('');
  };

  const fileToBase64 = (file) => new Promise((resolve, reject) => {
        if (!file) return resolve(null);
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = (error) => reject(error);
  });

  const structuredResponseSchema = useMemo(() => ({ type: "OBJECT", properties: { proTips: { type: "STRING" } } }), []);

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (hantaranItems.length === 0) { setErrors({hantaranItems: 'Wajib mengunggah minimal 1 foto barang hantaran.'}); return; }
    setErrors({}); onGenerate({ start: true });

    const apiKey = ""; // FIX: Deklarasi apiKey di sini agar terjangkau oleh semua panggilan API
    
    const allPresets = { decoration, photoStyle, otherDetail };
    const theme = allPresets.decoration.Theme?.value || 'Minimalist';
    const style = allPresets.decoration.Style?.value || 'Classic';
    const colorPaletteName = allPresets.decoration.ColorPalette?.value || 'Soft Pastels';
    const culture = allPresets.decoration.Culture?.value || 'Javanese';
    const propDensity = allPresets.decoration.PropDensity?.value || 'Medium (Beberapa Bunga & Properti)';
    const itemArrangement = allPresets.decoration.ItemArrangement?.value || 'Simetris & Tertata';
    const container = allPresets.decoration.Container?.value || 'Box Acrylic';
    const decorElement = allPresets.decoration.DecorationElement?.value || 'Bunga Segar';
    const background = allPresets.photoStyle.BackgroundColor?.value || 'Cream';

    try {
        const hantaranBase64List = await Promise.all(hantaranItems.map(fileToBase64));
        const containerBase64 = containerRef ? await fileToBase64(containerRef) : null;
        const decorBase64List = await Promise.all(decorElementRef.map(fileToBase64));

        const structuredQuery = `Expert advice (1 short paragraph) for hantaran: Container ${container}, Theme ${theme}, Style ${style}, Culture ${culture}. Use bolding.`;
        const structuredApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
        let structuredData = { proTips: "Tips tidak tersedia." };

        // 1. Generate Pro Tips (Text generation is faster, do it first)
        try {
            const structuredResponse = await fetchWithRetry(structuredApiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: structuredQuery }] }], generationConfig: { responseMimeType: "application/json", responseSchema: structuredResponseSchema } }) });
            const structuredResult = await structuredResponse.json();
            const jsonText = structuredResult?.candidates?.[0]?.content?.parts?.[0]?.text;
            if (jsonText) structuredData = JSON.parse(jsonText);
        } catch (e) { console.error("Text gen failed:", e); }


        // 2. Generate Image (2 Variations)
        const imageApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`;
        
        const promises = [1, 2].map(async (i) => {
            const imageParts = [];
            hantaranBase64List.forEach((b64) => { if (b64) imageParts.push({ inlineData: { mimeType: "image/jpeg", data: b64 } }); });
            if (containerBase64) imageParts.push({ inlineData: { mimeType: "image/jpeg", data: containerBase64 } });
            decorBase64List.forEach((b64) => { if (b64) imageParts.push({ inlineData: { mimeType: "image/jpeg", data: b64 } }); });
            
            const strictPrompt = `
            **SYSTEM ROLE: ELITE PRODUCT STYLIST & PHOTOGRAPHER - VARIATION ${i}**
            **TASK: DEEP VISUAL ANALYSIS & HANTARAN ARRANGEMENT GENERATION**

            **INPUT ANALYSIS (CHAIN OF THOUGHT PROCESS):**
            1.  **Visual Audit of Source Material:** - Analyze the uploaded "Hantaran Items" images carefully. Identify the material (e.g., velvet, gold, food, fabric?), exact colors, textures, and shape. 
                - *CRITICAL:* The visual identity of these items must be preserved in the final output. Do not hallucinate different items.
            
            2.  **Container & Structure Analysis:** - The user selected container: "${container}". 
                - ${containerRef ? "A specific reference image was provided for the container. Analyze its shape, transparency, and material properties." : "Use a standard, high-end commercial version of this container type."}
            
            3.  **Design Language & Preset Integration:**
                - **Theme:** ${theme}
                - **Style:** ${style}
                - **Cultural Nuance:** ${culture}
                - **ColorPalette:** ${colorPaletteName} (Ensure this harmonizes with the items)
                - **Arrangement Logic:** ${itemArrangement}
                - **Prop Density:** ${propDensity}
                - **Key Decoration:** ${decorElement}

            4.  **Synthesis & Composition Strategy:** - Mentally place the "Hantaran Items" into the "${container}" menggunakan the "${itemArrangement}" layout. 
                - Apply decoration elements (${decorElement}) consistent with the "${theme}" theme dan "${culture}" culture. 
                - Ensure the "${propDensity}" is respected (don't overcrowd if 'Minimalist', don't leave empty if 'High Density').
                - Harmonize the background (${background}) with the palette.

            **FINAL GENERATION DIRECTIVE:**
            Create a single, high-definition (8k), photorealistic image based on the synthesis above.
            - **Subject:** The fully arranged Hantaran box containing the user's items.
            - **Environment:** ${background} single draped fabric background. Professional studio lighting (Softbox) to create depth and elegant reflections.
            - **Camera:** Eye-level or slightly high-angle (45 degrees) to show contents clearly.
            - **Constraint:** NO spilling outside the container (unless 'Overflowing' density is set). NO text overlays.
            - **Detail Override:** ${allPresets.otherDetail || 'None'}
            `;
            imageParts.unshift({ text: strictPrompt });

            try {
                const imageResponse = await fetchWithRetry(imageApiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ role: "user", parts: imageParts }], generationConfig: { responseModalities: ['IMAGE'] } }) });
                const imageResult = await imageResponse.json();
                const base64Data = imageResult?.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                
                // FIX: Menambahkan pengecekan base64 dan logging finishReason
                if (!base64Data) {
                    const finishReason = imageResult?.candidates?.[0]?.finishReason;
                    const error = imageResult?.error?.message || 'Unknown API failure.';
                    console.error(`Image gen failed for variation ${i}. Reason: ${finishReason || 'Missing Data'}. Error detail: ${error}. Response:`, imageResult);
                }

                return base64Data ? `data:image/png;base64,${base64Data}` : null;
            } catch (e) { 
                console.error(`Image gen failed for variation ${i}:`, e);
                return null;
            }
        });

        const imageResults = await Promise.all(promises);
        const validImages = imageResults.filter(url => url !== null);
        
        if (validImages.length === 0) throw new Error("Gagal membuat gambar inspirasi.");

        onGenerate({ data: { images: validImages, proTips: structuredData.proTips }, start: false });
      } catch (error) {
          onGenerate({ data: { images: [], proTips: `Error: ${error.message}` }, start: false });
          // Menghapus alert()
      }
  };

  return (
    <form onSubmit={handleSubmit} className="flex flex-col gap-6 p-4 md:p-6">
      <h2 className="text-3xl font-bold text-center mb-4" style={{ color: colors.text }}>Inspirasi Hantaran</h2>
      <section className="p-5 rounded-xl bg-white shadow-md border-t-4" style={{ borderColor: colors.secondary }}>
        <h3 className="text-xl font-semibold mb-4 flex items-center gap-2" style={{ color: colors.text }}><Gift className="w-5 h-5" style={{ color: colors.secondary }} /> 1. Barang Hantaran</h3>
        <FileUpload label="Direkomendasikan foto barang menghadap depan" onFilesChange={setHantaranItems} maxFiles={5} files={hantaranItems} />
        {errors.hantaranItems && <p className="text-red-500 text-sm mt-2">{errors.hantaranItems}</p>}
      </section>

      <section className="p-5 rounded-xl bg-white shadow-md border-t-4" style={{ borderColor: colors.supporting }}>
        <h3 className="text-xl font-semibold mb-4 flex items-center gap-2" style={{ color: colors.text }}><Layers className="w-5 h-5" style={{ color: colors.supporting }} /> 2. Gaya & Referensi Dekorasi</h3>
        <div className="flex justify-end mb-4">
            <button type="button" onClick={handleSerahkanPadaAI} className="flex items-center gap-1 px-4 py-2 text-xs font-semibold rounded-full bg-gray-50 text-gray-700 shadow-sm border border-gray-200 hover:bg-gray-100 transition"><Sparkles className="w-3 h-3" style={{ color: colors.accent }} /> AI Auto-Fill Gaya</button>
        </div>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          {['Theme', 'Style', 'ColorPalette', 'Culture', 'PropDensity', 'ItemArrangement'].map((key) => (
             <InputGroup key={key} label={key.replace(/([A-Z])/g, ' $1').trim()} isAuto={decoration[key]?.isAuto || false} onToggleAuto={() => handleToggleAuto('decoration', key)}>
                <Dropdown value={decoration[key]?.value || ''} onChange={(e) => handleChange('decoration', key, e.target.value)} options={PRESET_OPTIONS.decoration[key]} disabled={decoration[key]?.isAuto} />
              </InputGroup>
          ))}
          {['Container', 'DecorationElement'].map((key) => {
            const isContainer = key === 'Container';
            const files = isContainer ? (containerRef ? [containerRef] : []) : decorElementRef;
            const onFilesChange = isContainer ? (f) => { setContainerRef(f[0] || null); handleChange('decoration', key, f.length > 0 ? 'Reference Upload' : ''); if (f.length > 0) setDecoration(prev => ({ ...prev, [key]: { ...prev[key], openText: "fokus hanya pada container", isAuto: false } })); } : (f) => { setDecorElementRef(f); handleChange('decoration', key, f.length > 0 ? 'Reference Upload' : ''); };
            return (
              <InputGroup key={key} label={key.replace(/([A-Z])/g, ' $1').trim()} isAuto={decoration[key]?.isAuto || false} onToggleAuto={() => handleToggleAuto('decoration', key)}>
                <Dropdown value={decoration[key]?.value || ''} onChange={(e) => handleChange('decoration', key, e.target.value)} options={PRESET_OPTIONS.decoration[key]} disabled={decoration[key]?.isAuto} />
                <FileUpload label={`Upload foto referensi ${key}`} onFilesChange={onFilesChange} maxFiles={isContainer ? 1 : 5} files={files} disabled={decoration[key]?.isAuto} />
                <OpenTextarea value={decoration[key]?.openText || ''} onChange={(e) => setDecoration(prev => ({ ...prev, [key]: { ...prev[key], openText: e.target.value, isAuto: false } }))} placeholder={`Atau tulis deskripsi spesifik...`} disabled={decoration[key]?.isAuto} />
              </InputGroup>
            );
          })}
        </div>
      </section>

      <section className="p-5 rounded-xl bg-white shadow-md border-t-4" style={{ borderColor: colors.primary }}>
        <h3 className="text-xl font-semibold mb-4 flex items-center gap-2" style={{ color: colors.text }}><Camera className="w-5 h-5" style={{ color: colors.primary }} /> 3. Detail Lain</h3>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
          {Object.entries(PRESET_OPTIONS.photoStyle).map(([key, options]) => (
            <InputGroup key={key} label={key.replace(/([A-Z])/g, ' $1').trim()} isAuto={photoStyle[key]?.isAuto || false} onToggleAuto={() => handleToggleAuto('photoStyle', key)}>
              <Dropdown value={photoStyle[key]?.value || ''} onChange={(e) => handleChange('photoStyle', key, e.target.value)} options={options} disabled={photoStyle[key]?.isAuto} />
            </InputGroup>
          ))}
          <InputGroup label="Detail Tambahan" isAuto={false} onToggleAuto={null}><OpenTextarea value={otherDetail} onChange={(e) => setOtherDetail(e.target.value)} placeholder="Tuliskan detail lain..." /></InputGroup>
        </div>
      </section>
      <div className="w-full md:w-2/3 lg:w-1/2 mx-auto h-14">
      {isGenerating ? <div className="flex justify-center items-center h-full"><svg className="animate-spin h-10 w-10" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke={colors.primary} strokeWidth="4" fill="none" className="opacity-25" /><path d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" fill={colors.secondary} /></svg></div> : <button type="submit" disabled={hantaranItems.length === 0} className={`w-full py-3 px-8 text-lg font-bold text-white rounded-full transition-all duration-300 shadow-xl h-full ${hantaranItems.length === 0 ? 'opacity-60' : 'hover:scale-105'}`} style={{ background: `linear-gradient(90deg, ${colors.primary} 0%, ${colors.supporting} 100%)` }}>Buat Hantaran</button>}
      </div>
    </form>
  );
};

const ArrangementIdeaResults = ({ results, isLoading, colors, setEditContext }) => {
    // MODIFIKASI: Menggunakan struktur grid dan modal yang mirip dengan MaharDesignResults/MagicPhotoResults
    const { images, proTips } = results?.data || {};
    const [viewIndex, setViewIndex] = useState(0);
    const [isModalOpen, setIsModalOpen] = useState(false);

    const handleDownload = (url, index) => {
        safeDownload(url, `Hantaran-Var${index+1}-${Date.now()}.png`);
    };
    
    // Fungsi untuk membuka modal edit
    const handleEdit = (image, index) => {
        setEditContext({ image, index, layout: '1:1 (Square)' }); // Layout default square
    };

    if (isLoading) return <div className="p-4 md:p-6 h-full flex flex-col justify-center"><SkeletonLoading primaryColor={colors.primary} secondaryColor={colors.secondary} bgColor={colors.bg} /></div>;
    
    if (!images || images.length === 0) return (
        <div className="flex flex-col items-center justify-center h-full min-h-[500px] p-8 text-center" style={{ color: colors.text }}>
            <Gift className="w-20 h-20 mb-4 opacity-30" />
            <h3 className="text-xl font-semibold mb-2">Siap Menerima Inspirasi?</h3>
            <p className="text-gray-500">Hasil desain inspirasi Anda akan muncul di sini.</p>
        </div>
    );

    return (
        <div className="flex flex-col gap-8 p-4 md:p-6">
            <h2 className="text-3xl font-bold text-center" style={{ color: colors.text }}>Hasil Studio</h2>
            
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                {/* Panel Pro Tips di sebelah kiri atau atas */}
                 <div className="col-span-full md:col-span-1 p-5 rounded-xl bg-white shadow-lg border-l-4 h-fit md:h-full" style={{ borderColor: colors.primary }}>
                    <h3 className="text-xl font-semibold mb-3 flex items-center gap-2" style={{ color: colors.text }}><Feather className="w-5 h-5" /> Pro Tips</h3>
                    <div className="font-sans text-sm" style={{ color: colors.text }}>{renderProTips(proTips)}</div>
                </div>

                {/* Grid Gambar di sebelah kanan atau bawah */}
                <div className="col-span-full md:col-span-1 grid grid-cols-1 gap-6">
                    {images.map((img, idx) => (
                         // MODIFIKASI: Menambahkan aspect-square untuk tampilan gambar yang konsisten
                        <div key={idx} className="group relative aspect-square rounded-2xl overflow-hidden shadow-xl border-4 bg-white cursor-pointer transition duration-300" style={{ borderColor: colors.primary }}>
                            <img src={img} alt={`Inspiration ${idx+1}`} className="w-full h-full object-cover" />
                             {/* Tombol Maximize, Download, dan Edit (Meniru Magic Photo) */}
                            <div className="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition flex items-center justify-center gap-3">
                                <button onClick={() => { setViewIndex(idx); setIsModalOpen(true); }} className="p-2 bg-white/20 backdrop-blur rounded-full text-white hover:bg-white/40" title="Lihat"><Maximize2 className="w-5 h-5" /></button>
                                <button onClick={() => handleDownload(img, idx)} className="p-2 bg-white/20 backdrop-blur rounded-full text-white hover:bg-white/40" title="Download"><Download className="w-5 h-5" /></button>
                                <button onClick={() => handleEdit(img, idx)} className="p-2 bg-white/20 backdrop-blur rounded-full text-white hover:bg-white/40" title="Edit Lanjutan"><Wand2 className="w-5 h-5" /></button>
                            </div>
                            <div className="absolute top-2 left-2 bg-black/50 text-white text-[10px] px-2 py-1 rounded-full backdrop-blur-sm">Var {idx + 1}</div>
                        </div>
                    ))}
                </div>
            </div>

            {isModalOpen && (
                 <div className="fixed inset-0 z-[60] bg-black/95 flex items-center justify-center p-4 backdrop-blur-md" onClick={() => setIsModalOpen(false)}>
                    
                    {/* Red Close Button */}
                    <button 
                        className="absolute top-4 right-4 p-2 z-50 rounded-full transition" 
                        onClick={(e) => { e.stopPropagation(); setIsModalOpen(false); }}
                        style={{ backgroundColor: colors.secondary, color: 'white' }} 
                    >
                        <X className="w-8 h-8" />
                    </button>
                    
                    {/* Previous Button (Slider) */}
                    {images.length > 1 && (
                        <button 
                            className="absolute left-4 text-white/80 hover:text-white p-4 transition" 
                            onClick={(e) => { e.stopPropagation(); setViewIndex(prev => prev === 0 ? images.length - 1 : prev - 1); }}
                        >
                            <ChevronLeft className="w-10 h-10" />
                        </button>
                    )}

                    <div 
                        className="max-w-3xl max-h-[85vh] relative group"
                        onClick={(e) => e.stopPropagation()}
                    >
                        <img src={images[viewIndex]} alt="Full View" className="max-h-[85vh] w-auto object-contain rounded-lg shadow-2xl aspect-square" />
                        <div className="absolute bottom-4 right-4 flex gap-3">
                             <button onClick={(e) => { e.stopPropagation(); handleDownload(images[viewIndex], viewIndex); }} className="bg-white/90 hover:bg-white text-gray-800 px-4 py-2 rounded-full font-bold shadow-lg flex items-center gap-2">
                                <Download className="w-4 h-4" /> Download
                            </button>
                            <button onClick={(e) => { e.stopPropagation(); setIsModalOpen(false); handleEdit(images[viewIndex], viewIndex); }} className="bg-white/90 hover:bg-white text-gray-800 px-4 py-2 rounded-full font-bold shadow-lg flex items-center gap-2">
                                <Wand2 className="w-4 h-4" /> Edit
                            </button>
                        </div>
                    </div>

                    {/* Next Button (Slider) */}
                    {images.length > 1 && (
                        <button 
                            className="absolute right-4 text-white/80 hover:text-white p-4 transition" 
                            onClick={(e) => { e.stopPropagation(); setViewIndex(prev => (prev + 1) % images.length); }}
                        >
                            <ChevronRight className="w-10 h-10" />
                        </button>
                    )}

                    {/* Index indicator */}
                    <div className="absolute bottom-8 flex gap-2">
                        {images.map((_, idx) => (
                            <div key={idx} className={`w-2 h-2 rounded-full transition-all ${idx === viewIndex ? 'bg-white w-6' : 'bg-white/40'}`} />
                        ))}
                    </div>
                </div>
            )}
        </div>
    );
};

// --- APLIKASI UTAMA ---

const App = () => {
  const [isSidebarOpen, setIsSidebarOpen] = useState(true);
  const [activeModule, setActiveModule] = useState(MODULES[4].id); // Default to Order Tracker
  const [results, setResults] = useState(null);
  const [isGenerating, setIsGenerating] = useState(false);
  const [editContext, setEditContext] = useState(null); 
  
  // Firebase States
  const [db, setDb] = useState(null);
  const [auth, setAuth] = useState(null);
  const [userId, setUserId] = useState(null);
  const [isAuthReady, setIsAuthReady] = useState(false);


  // --- FIREBASE INITIALIZATION & AUTHENTICATION ---
  useEffect(() => {
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
    if (!firebaseConfig) {
        console.error("Firebase config is missing.");
        setIsAuthReady(true);
        return;
    }
    
    let unsubscribe = () => {};

    const initFirebase = async () => {
      try {
          const app = initializeApp(firebaseConfig);
          const firestore = getFirestore(app);
          const firebaseAuth = getAuth(app);
          
          setDb(firestore);
          setAuth(firebaseAuth);

          const authToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

          // CRITICAL FIX: Await the sign-in operation to ensure a user context is available
          // before setting up the listener and marking auth ready.
          try {
              if (authToken) {
                  await signInWithCustomToken(firebaseAuth, authToken);
              } else {
                  await signInAnonymously(firebaseAuth);
              }
          } catch (error) {
              console.error("Initial Firebase Auth failed:", error);
              // Sign-in failed, the user might be null, but we still proceed to monitor.
          }
          
          // Use onAuthStateChanged to capture the final, stable state (which should now be authenticated)
          unsubscribe = onAuthStateChanged(firebaseAuth, (user) => {
              if (user) {
                  setUserId(user.uid);
              } else {
                  // Fallback ID if for some reason user is null after sign-in (shouldn't happen with anonymous)
                  setUserId(crypto.randomUUID()); 
              }
              // Mark as ready only after auth state is confirmed via the listener
              setIsAuthReady(true);
          });
          
      } catch (e) {
          console.error("Firebase Initialization Error:", e);
          setIsAuthReady(true);
      }
    };

    initFirebase();

    return () => unsubscribe();

  }, []); // Run only once on mount


  const toggleSidebar = () => setIsSidebarOpen(prev => !prev);
  const handleGenerate = ({ data, start }) => { 
    if (start !== undefined) setIsGenerating(start); 
    if (data) setResults(data); 
  };
  
  // Fungsi baru untuk memperbarui satu gambar dalam results
  const updateSingleImage = useCallback((index, newImageUrl, layout = '1:1 (Square)') => {
        setResults(prev => {
            if (!prev) return null;

            const newResults = { ...prev };
            
            if (newResults.images) { // For Arrangement, Bouquet, Mahar (simple array)
                const newImages = [...newResults.images];
                newImages[index] = newImageUrl;
                newResults.images = newImages;
            } else if (newResults.results) { // For Magic Photo (complex array with layout)
                const newResultsArray = [...newResults.results];
                newResultsArray[index] = { image: newImageUrl, layout: layout };
                newResults.results = newResultsArray;
            }

            return newResults;
        });
    }, []);

  const currentModuleComponent = useMemo(() => {
    if (activeModule === 'arrangement') return <ArrangementIdeaForm onGenerate={handleGenerate} isGenerating={isGenerating} colors={colors} />;
    if (activeModule === 'mahar') return <MaharDesignForm onGenerate={handleGenerate} isGenerating={isGenerating} colors={colors} />; 
    if (activeModule === 'bouquet') return <FlowerBouquetForm onGenerate={handleGenerate} isGenerating={isGenerating} colors={colors} />;
    if (activeModule === 'invoice') return <InvoiceMaker colors={colors} APP_LOGO_URL={APP_LOGO_URL} />;
    if (activeModule === 'checker') return <ItemChecker colors={colors} APP_LOGO_URL={APP_LOGO_URL} />;
    if (activeModule === 'magic') return <MagicPhotoForm onGenerate={handleGenerate} isGenerating={isGenerating} colors={colors} />;
    if (activeModule === 'tracker') return <OrderTracker colors={colors} db={db} userId={userId} isAuthReady={isAuthReady} />;
    return <div className="p-8 text-center">Modul sedang dikembangkan.</div>;
  }, [activeModule, isGenerating, db, userId, isAuthReady]); // Tambahkan dependencies Firebase

  return (
    <div className="flex h-screen overflow-hidden" style={{ backgroundColor: colors.bg, color: colors.text }}>
      <nav className={`fixed md:relative flex flex-col h-full shadow-xl transition-all duration-300 z-50 ${isSidebarOpen ? 'w-64 p-4' : 'w-0 p-0 md:w-16 md:p-2'}`} style={{ borderTopRightRadius: '1.5rem', borderBottomRightRadius: '1.5rem', backgroundColor: colors.primary }}>
        {/* PERBAIKAN: Set overflow-y-auto menjadi overflow-hidden dan menggunakan flex-col untuk kontrol layout */}
        <div className={`flex ${isSidebarOpen ? 'flex-col items-start gap-4' : 'justify-center'} items-center mb-4 h-12 pb-4 border-b border-white/30`}>
          {isSidebarOpen && (
            <div className="flex items-center w-full justify-between">
              <div className="flex items-center gap-3">
                <img src={APP_LOGO_URL} className="w-12 h-12" alt="App Logo" /> {/* Logo Lebih Besar */}
                <h1 className="text-xl text-white flex flex-col leading-none">
                  <span style={{ fontFamily: 'Georgia, serif', fontWeight: 'bold' }}>HANTARAN</span>
                  <span className="text-xs uppercase font-bold" style={{ opacity: 0.8 }}>STUDIO</span>
                </h1>
              </div>
              <button onClick={toggleSidebar} className="p-2 rounded-full hover:bg-white/20 text-white"><X className="w-6 h-6" /></button>
            </div>
          )}
           {!isSidebarOpen && <button onClick={toggleSidebar} className="p-2 rounded-full hover:bg-white/20 text-white"><PanelRight className="w-6 h-6" /></button>}
        </div>

        {/* Daftar Modul: Menghapus scrollbar dengan overflow-hidden */}
        <ul className="flex flex-col gap-2 flex-1 pb-4 border-b border-white/30 overflow-hidden">
          {MODULES.map(module => (
            <li key={module.id}>
              <button onClick={() => { if (!module.disabled) setActiveModule(module.id); if (window.innerWidth < 768) setIsSidebarOpen(false); }} disabled={module.disabled} className={`flex items-center w-full px-4 py-3 rounded-xl transition-all duration-300 relative font-bold ${activeModule === module.id ? 'bg-white shadow-lg scale-[1.01]' : 'text-white hover:bg-white/20'}`} style={{ color: activeModule === module.id ? colors.text : 'white' }}>
                {activeModule === module.id && <div className="absolute left-0 top-0 h-full w-1 rounded-l-xl" style={{ backgroundColor: colors.secondary }} />}
                <module.icon className={`w-5 h-5 ${isSidebarOpen ? 'mr-3' : 'mx-auto'}`} />{isSidebarOpen && <span>{module.name}</span>}
              </button>
            </li>
          ))}
        </ul>
        
        {/* Footer Sidebar */}
        <div className="mt-auto pt-4 flex justify-center p-3">
             {isSidebarOpen ? <div className="flex items-center gap-3"><CircleUser className="w-6 h-6 text-white" /><div className="text-sm text-white"><p className="text-xs opacity-80">Developed by</p><p className="font-bold">NGATUR BISNIS</p></div></div> : <CircleUser className="w-6 h-6 text-white" />}
        </div>
      </nav>

      <div className="flex-1 flex overflow-hidden">
        {!isSidebarOpen && <button onClick={toggleSidebar} className="absolute top-4 left-4 p-2 rounded-full md:hidden hover:bg-gray-200 z-40" style={{ color: colors.text, backgroundColor: colors.bg }}><PanelLeft className="w-6 h-6" /></button>}
        <div className="flex-1 p-4 md:p-8 overflow-y-auto">
          <div className="flex flex-col gap-8 w-full h-full">
            <div className={`w-full bg-white rounded-3xl shadow-xl p-2 ${['invoice', 'checker', 'tracker'].includes(activeModule) ? 'h-full' : 'h-fit'}`} style={{ backgroundColor: colors.bg }}>{currentModuleComponent}</div>
            
            {/* Hasil Design Modules, passing setEditContext and updateSingleImage */}
            {activeModule === 'arrangement' && <div className="w-full bg-white rounded-3xl shadow-xl p-2 h-fit" style={{ backgroundColor: colors.bg }}><ArrangementIdeaResults results={{data: results}} isLoading={isGenerating} colors={colors} setEditContext={setEditContext} /></div>}
            {activeModule === 'bouquet' && <div className="w-full bg-white rounded-3xl shadow-xl p-2 h-fit" style={{ backgroundColor: colors.bg }}><FlowerBouquetResults results={{data: results}} isLoading={isGenerating} colors={colors} setEditContext={setEditContext} /></div>}
            {activeModule === 'mahar' && <div className="w-full bg-white rounded-3xl shadow-xl p-2 h-fit" style={{ backgroundColor: colors.bg }}><MaharDesignResults results={{data: results}} isLoading={isGenerating} colors={colors} setEditContext={setEditContext} /></div>}
            {activeModule === 'magic' && <div className="w-full bg-white rounded-3xl shadow-xl p-2 h-fit" style={{ backgroundColor: colors.bg }}><MagicPhotoResults results={{data: results}} isLoading={isGenerating} colors={colors} setEditContext={setEditContext} /></div>}
          </div>
        </div>
      </div>
      
      {/* Re-Edit Modal, muncul jika editContext terisi */}
      {editContext && (
             <ReEditModal
                isOpen={!!editContext}
                onClose={() => setEditContext(null)}
                originalItem={editContext}
                onUpdateImage={updateSingleImage}
                colors={colors}
             />
        )}

    </div>
  );
};

export default App;
